<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappy | Dashboard</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #cbd5e1; /* Slate 300 */
        }
        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #e2e8f0; /* Slate 200 */
        }
        .btn-secondary:hover {
            background-color: #475569; /* Slate 600 */
        }
        .btn-danger {
            background-color: #dc2626; /* Red 600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* Red 700 */
        }
        .form-input, .form-select {
            width: 100%;
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            color: #f1f5f9; /* Slate 100 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 2px #312e81; /* Indigo 800 */
        }
        .hidden {
            display: none !important; /* Use !important to override Tailwind's flex/block etc. */
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
        }
        .log-box {
            background-color: #0f172a;
            border: 1px solid #334155;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8); /* Slate 900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- App Container -->
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden max-w-md mx-auto">
            <div class="card">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-6">Login to Zappy</h2>
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="email" class="block mb-2 text-sm font-medium text-slate-400">Username (Email)</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2 text-sm font-medium text-slate-400">Password</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <p id="auth-error" class="text-red-400 text-sm mb-4 text-center"></p>
                    <button id="auth-submit-btn" type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p class="text-center text-sm text-slate-400 mt-6">
                    <span id="auth-prompt-text">Don't have an account?</span>
                    <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-400 hover:text-indigo-300">Register</a>
                </p>
            </div>
        </div>

        <!-- Main Dashboard Section (Post-Login) -->
        <div id="dashboard-section" class="hidden">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Your Servers</h1>
                    <p class="text-slate-400">Manage your servers or join a new one.</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-slate-300"></span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </header>

            <!-- Server Interaction -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Create a New Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Use your ER:LC Server API Key to create and manage a server group.</p>
                    <button id="show-create-server-modal-btn" class="btn btn-primary">Create Server</button>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Join a Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Enter a server code provided by a server owner to request access.</p>
                    <div class="flex gap-2">
                        <input type="text" id="join-code-input" placeholder="Enter Server Code" class="form-input">
                        <button id="join-server-btn" class="btn btn-secondary">Join</button>
                    </div>
                     <p id="join-server-error" class="text-red-400 text-sm mt-2 text-center"></p>
                     <p id="join-server-success" class="text-green-400 text-sm mt-2 text-center"></p>
                </div>
            </div>

            <!-- Server List -->
            <div>
                <h2 class="text-2xl font-bold text-white mb-4">Server List</h2>
                <div id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Server cards will be injected here -->
                </div>
                 <p id="server-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
            </div>
        </div>

        <!-- Server Panel Section (Selected Server) -->
        <div id="server-panel-section" class="hidden">
            <!-- Panel Header -->
            <header class="mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <button id="back-to-dashboard-btn" class="btn btn-secondary mb-4">&larr; Back to Dashboard</button>
                        <h1 id="panel-server-name" class="text-3xl font-bold text-white">Server Name</h1>
                        <p id="panel-server-code" class="text-slate-400 font-mono"></p>
                    </div>
                    <div id="shift-controls" class="card p-4 flex items-center gap-4">
                        <p class="text-slate-300">Your Shift: <span id="shift-timer" class="font-mono">00:00:00</span></p>
                        <button id="shift-toggle-btn" class="btn btn-primary">Start Shift</button>
                         <p id="shift-controls-message" class="text-sm mt-2 text-center"></p>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="mb-6">
                <div id="panel-tab-buttons" class="flex flex-wrap items-center gap-2 border-b border-slate-700 pb-2">
                    <button class="tab-button btn btn-secondary active" data-tab="main">Server Info</button>
                    <button class="tab-button btn btn-secondary" data-tab="players">Players</button>
                    <button class="tab-button btn btn-secondary" data-tab="vehicles">Vehicles</button>
                    <button class="tab-button btn btn-secondary" data-tab="killlogs">Kill Logs</button>
                    <button class="tab-button btn btn-secondary" data-tab="punishments">Punishments</button>
                    <button class="tab-button btn btn-secondary" data-tab="commands">Execute</button>
                    <button class="tab-button btn btn-secondary" data-tab="shifts">Shifts</button>
                    <!-- Owner-only tab is added dynamically -->
                </div>
            </div>

            <!-- Tab Content -->
            <div id="panel-tab-content">
                <!-- Main Info Tab -->
                <div id="tab-main" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Server Statistics</h3>
                            <button id="refresh-stats-btn" class="btn btn-secondary btn-sm mb-4">Refresh Stats</button>
                            <div id="server-stats-output">Loading...</div>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Real-time Events</h3>
                            <div id="log-output" class="log-box">Connecting...</div>
                        </div>
                    </div>
                </div>

                <!-- Players Tab -->
                <div id="tab-players" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Players & Queue</h3>
                        <button id="refresh-players-btn" class="btn btn-secondary btn-sm mb-4">Refresh Players</button>
                        <p class="mb-4">Online: <span id="player-count">0</span> | Queue: <span id="queue-count">0</span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold mb-2">Online Players</h4>
                                <ul id="player-list" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Queued Players</h4>
                                <ul id="player-queue" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Join Requests</h4>
                                <ul id="join-requests-display" class="log-box"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicles Tab -->
                <div id="tab-vehicles" class="tab-content card hidden">
                    <h3 class="text-xl font-semibold mb-4 text-white">Vehicle Data</h3>
                    <p class="text-slate-400 mb-4">Vehicle data would be displayed here.</p>
                    <button id="refresh-vehicles-btn" class="btn btn-secondary btn-sm mb-4">Refresh Vehicles</button>
                    <div id="vehicle-list" class="log-box">No vehicle data available.</div>
                </div>

                <!-- Kill Logs Tab -->
                <div id="tab-killlogs" class="tab-content card hidden">
                    <h3 class="text-xl font-semibold mb-4 text-white">Kill Logs</h3>
                    <p class="text-slate-400 mb-4">Kill logs would be displayed here.</p>
                    <button id="refresh-killlogs-btn" class="btn btn-secondary btn-sm mb-4">Refresh Kill Logs</button>
                    <div id="kill-log-list" class="log-box">No kill logs available.</div>
                </div>

                <!-- Punishments Tab -->
                <div id="tab-punishments" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Punishment System</h3>
                        <p class="text-slate-400 mb-4">Issue, lookup, and manage player punishments.</p>

                        <!-- Add Punishment Section -->
                        <div class="mb-8 p-6 bg-slate-700 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4">Add New Punishment</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="punish-username-input" class="block mb-2 text-sm font-medium">Username</label>
                                    <input type="text" id="punish-username-input" class="form-input" placeholder="Roblox Username" required>
                                </div>
                                <div>
                                    <label for="punish-type-select" class="block mb-2 text-sm font-medium">Punishment Type</label>
                                    <select id="punish-type-select" class="form-select" required>
                                        <option value="" disabled selected>Select a type</option>
                                        <option value="Kick">Kick</option>
                                        <option value="Warn">Warn</option>
                                        <option value="Ban">Ban</option>
                                        <option value="Temp Ban">Temp Ban</option>
                                    </select>
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <label for="punish-reason-input" class="block mb-2 text-sm font-medium">Reason</label>
                                    <textarea id="punish-reason-input" class="form-input" rows="3" placeholder="Reason for punishment..." required></textarea>
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <label for="punish-duration-input" class="block mb-2 text-sm font-medium">Duration (Days, for Temp Ban)</label>
                                    <input type="number" id="punish-duration-input" class="form-input" placeholder="e.g., 7" min="1">
                                </div>
                                <div class="col-span-1 md:col-span-2 flex justify-end">
                                    <button id="add-punishment-btn" class="btn btn-primary">Add Punishment</button>
                                </div>
                            </div>
                        </div>

                        <!-- Lookup/List Punishments Section -->
                        <h4 class="text-lg font-bold text-white mb-4">Lookup Punishments</h4>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="punish-lookup-input" class="form-input" placeholder="Lookup by username">
                            <button id="punish-lookup-btn" class="btn btn-secondary">Search</button>
                            <button id="punish-show-all-btn" class="btn btn-secondary">Show All</button>
                        </div>
                        <div id="punishments-list" class="log-box">
                            No punishments found.
                        </div>
                    </div>
                </div>

                <!-- Commands Tab -->
                <div id="tab-commands" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Execute Command</h3>
                        <p class="text-slate-400 mb-4 text-sm">Enter a command to execute on the ER:LC server.</p>
                        <div id="command-input-container" class="flex gap-2">
                            <input type="text" id="command-input" placeholder="e.g., :kick PlayerName" class="form-input">
                            <button id="execute-command-button" class="btn btn-primary">Execute</button>
                        </div>
                        <div id="command-response" class="mt-4 p-3 rounded-md bg-slate-900 text-sm"></div>
                    </div>
                </div>

                <!-- Shifts Tab -->
                <div id="tab-shifts" class="tab-content hidden">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Shift Leaderboard</h3>
                            <div id="shift-wave-controls">
                                <!-- Owner-only controls added here -->
                                <button id="start-shift-wave-btn" class="btn btn-primary btn-sm hidden">Start Shift Wave</button>
                                <button id="end-shift-wave-btn" class="btn btn-danger btn-sm hidden">End Shift Wave</button>
                            </div>
                        </div>
                        <div id="shift-leaderboard" class="space-y-2">Loading...</div>
                    </div>
                </div>

                <!-- Owner Admin Tab -->
                <div id="tab-owner" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Join Requests</h3>
                            <div id="owner-join-requests-list" class="space-y-3">No pending requests.</div>
                             <p id="owner-join-requests-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Manage Server Members</h3>
                            <div id="server-members-list" class="log-box mb-4">No members to display.</div>
                             <p id="server-members-message" class="text-sm mt-2 text-center"></p>
                            <hr class="border-slate-700 my-6">
                            <h3 class="text-xl font-semibold text-white mb-4">Server Settings</h3>
                            <p class="text-slate-400 text-sm mb-4">Only the server name can be changed after creation. The server code is permanently linked to the server's database ID.</p>
                            <label for="edit-server-name" class="block mb-2">Server Name</label>
                            <input type="text" id="edit-server-name" class="form-input mb-4">
                            <button id="save-server-name-btn" class="btn btn-primary">Save Name</button>
                             <p id="owner-settings-success" class="text-green-400 text-sm mt-2 text-center"></p>
                             <p id="owner-settings-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <label for="edit-api-key" class="block mb-2">ER:LC Server API Key</label>
                            <input type="password" id="edit-api-key" class="form-input mb-4">
                            <button id="save-api-key-btn" class="btn btn-primary">Save API Key</button>
                            <p id="owner-api-key-success" class="text-green-400 text-sm mt-2 text-center"></p>
                            <p id="owner-api-key-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <h4 class="font-semibold text-red-400 mb-2">Danger Zone</h4>
                            <button id="delete-server-btn" class="btn btn-danger">Delete Server</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="create-server-modal" class="modal-overlay hidden">
        <div class="card max-w-lg w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Create Server</h2>
            <form id="create-server-form">
                <div class="mb-4">
                    <label for="server-name" class="block mb-2 text-sm font-medium">Server Name</label>
                    <input type="text" id="server-name" class="form-input" required placeholder="My Awesome Community">
                </div>
                <div class="mb-4">
                    <label for="server-code" class="block mb-2 text-sm font-medium">Server Code</label>
                    <input type="text" id="server-code" class="form-input" required placeholder="A unique code for users to join">
                    <p class="text-xs text-slate-400 mt-1">This must be unique across all of Zappy.</p>
                </div>
                <div class="mb-6">
                    <label for="api-key" class="block mb-2 text-sm font-medium">ER:LC Server API Key</label>
                    <input type="password" id="api-key" class="form-input" required>
                    <p class="text-xs text-yellow-400 mt-1">Your key is stored securely and is not shared with server members.</p>
                </div>
                <p id="create-server-error" class="text-red-400 text-sm mb-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-create-server-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Modal for Confirmations -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="card max-w-sm w-full text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Punishment Edit Modal -->
    <div id="edit-punishment-modal" class="modal-overlay hidden">
        <div class="card max-w-lg w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Edit Punishment</h2>
            <form id="edit-punishment-form">
                <input type="hidden" id="edit-punishment-doc-id">
                <div class="mb-4">
                    <label for="edit-punish-username" class="block mb-2 text-sm font-medium">Username</label>
                    <input type="text" id="edit-punish-username" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-punish-type" class="block mb-2 text-sm font-medium">Punishment Type</label>
                    <select id="edit-punish-type" class="form-select" required>
                        <option value="Kick">Kick</option>
                        <option value="Warn">Warn</option>
                        <option value="Ban">Ban</option>
                        <option value="Temp Ban">Temp Ban</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-punish-reason" class="block mb-2 text-sm font-medium">Reason</label>
                    <textarea id="edit-punish-reason" class="form-input" rows="3" required></textarea>
                </div>
                <div class="mb-6">
                    <label for="edit-punish-duration" class="block mb-2 text-sm font-medium">Duration (Days, for Temp Ban)</label>
                    <input type="number" id="edit-punish-duration" class="form-input" min="1">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-edit-punishment-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Use __firebase_config and __app_id if available, otherwise fallback to provided config
        const firebaseConfig = {
            apiKey: "AIzaSyCF5bqrinHuV81qTrcoIerlIZAnenvspsw",
            authDomain: "zappyerlc.firebaseapp.com",
            projectId: "zappyerlc",
            storageBucket: "zappyerlc.firebasestorage.app",
            messagingSenderId: "133579238168",
            appId: "1:133579238168:web:00ff14f7c2014ae2164c6d",
            measurementId: "G-K4LDYN8L3E"
        };
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use default-app-id for local testing

        // Import statements - updated to 11.9.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, updateDoc, deleteDoc, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /**
         * ZappyApp
         * A structured object to organize all application logic, simulating a modular file structure.
         */
        const ZappyApp = {
            // --- STATE & CONFIG ---
            state: {
                currentUser: null,
                currentServer: null,
                shiftInterval: null,
                shiftStartTime: null,
                shiftTimerRunning: false,
                unsubscribeListeners: [], // To store unsubscribe functions for cleanup
                isOwner: false, // Tracks if the current user is the server owner
                eventListeners: {}, // Stores references to event listeners for removal
                authMode: 'login' // 'login' or 'register'
            },

            // --- UI ELEMENT CACHING ---
            elements: {},

            /**
             * Caches all the necessary DOM elements.
             */
            cacheElements: function() {
                this.elements = {
                    loadingOverlay: document.getElementById('loading-overlay'),
                    authSection: document.getElementById('auth-section'),
                    dashboardSection: document.getElementById('dashboard-section'),
                    serverPanelSection: document.getElementById('server-panel-section'),
                    createServerModal: document.getElementById('create-server-modal'),
                    confirmModal: document.getElementById('confirm-modal'),
                    editPunishmentModal: document.getElementById('edit-punishment-modal'),
                    
                    // Auth Form elements
                    authTitle: document.getElementById('auth-title'),
                    authForm: document.getElementById('auth-form'),
                    authToggleLink: document.getElementById('auth-toggle-link'),
                    authPromptText: document.getElementById('auth-prompt-text'),
                    authSubmitBtn: document.getElementById('auth-submit-btn'),
                    authError: document.getElementById('auth-error'),
                    emailInput: document.getElementById('email'),
                    passwordInput: document.getElementById('password'),

                    // Dashboard Elements
                    serverList: document.getElementById('server-list'),
                    userEmailSpan: document.getElementById('user-email'),
                    joinServerError: document.getElementById('join-server-error'),
                    joinServerSuccess: document.getElementById('join-server-success'),
                    serverListError: document.getElementById('server-list-error'),
                    showCreateServerModalBtn: document.getElementById('show-create-server-modal-btn'),
                    joinServerBtn: document.getElementById('join-server-btn'),
                    logoutBtn: document.getElementById('logout-btn'),

                    // Panel Elements
                    backToDashboardBtn: document.getElementById('back-to-dashboard-btn'),
                    panelServerName: document.getElementById('panel-server-name'),
                    panelServerCode: document.getElementById('panel-server-code'),
                    shiftTimer: document.getElementById('shift-timer'),
                    shiftToggleButton: document.getElementById('shift-toggle-btn'),
                    panelTabButtons: document.getElementById('panel-tab-buttons'),
                    panelTabContent: document.getElementById('panel-tab-content'),
                    logOutput: document.getElementById('log-output'),
                    serverStatsOutput: document.getElementById('server-stats-output'),
                    playerCount: document.getElementById('player-count'),
                    queueCount: document.getElementById('queue-count'),
                    playerList: document.getElementById('player-list'),
                    playerQueue: document.getElementById('player-queue'),
                    joinRequestsDisplay: document.getElementById('join-requests-display'),
                    commandInput: document.getElementById('command-input'),
                    commandResponse: document.getElementById('command-response'),
                    shiftLeaderboard: document.getElementById('shift-leaderboard'),
                    ownerJoinRequestsList: document.getElementById('owner-join-requests-list'),
                    editServerNameInput: document.getElementById('edit-server-name'),
                    editApiKeyInput: document.getElementById('edit-api-key'),
                    deleteServerBtn: document.getElementById('delete-server-btn'),
                    executeCommandButton: document.getElementById('execute-command-button'),
                    refreshPlayersBtn: document.getElementById('refresh-players-btn'),
                    refreshVehiclesBtn: document.getElementById('refresh-vehicles-btn'),
                    refreshKillLogsBtn: document.getElementById('refresh-killlogs-btn'),
                    refreshCommandLogsBtn: document.getElementById('refresh-commandlogs-btn'),
                    startShiftWaveBtn: document.getElementById('start-shift-wave-btn'),
                    endShiftWaveBtn: document.getElementById('end-shift-wave-btn'),
                    shiftControlsMessage: document.getElementById('shift-controls-message'),
                    vehicleList: document.getElementById('vehicle-list'),
                    killLogList: document.getElementById('kill-log-list'),
                    
                    // Punishment Tab Elements
                    punishUsernameInput: document.getElementById('punish-username-input'),
                    punishTypeSelect: document.getElementById('punish-type-select'),
                    punishReasonInput: document.getElementById('punish-reason-input'),
                    punishDurationInput: document.getElementById('punish-duration-input'),
                    addPunishmentBtn: document.getElementById('add-punishment-btn'),
                    punishLookupInput: document.getElementById('punish-lookup-input'),
                    punishLookupBtn: document.getElementById('punish-lookup-btn'),
                    punishShowAllBtn: document.getElementById('punish-show-all-btn'),
                    punishmentsList: document.getElementById('punishments-list'),

                    // Edit Punishment Modal Elements
                    editPunishmentDocId: document.getElementById('edit-punishment-doc-id'),
                    editPunishUsername: document.getElementById('edit-punish-username'),
                    editPunishType: document.getElementById('edit-punish-type'),
                    editPunishReason: document.getElementById('edit-punish-reason'),
                    editPunishDuration: document.getElementById('edit-punish-duration'),
                    editPunishmentForm: document.getElementById('edit-punishment-form'),
                    cancelEditPunishmentBtn: document.getElementById('cancel-edit-punishment-btn'),

                };
            },

            /**
             * Removes all stored event listeners.
             */
            removeListeners: function() {
                for (const eventId in this.state.eventListeners) {
                    const listener = this.state.eventListeners[eventId];
                    if (listener.element && listener.handler) {
                        listener.element.removeEventListener(listener.event, listener.handler);
                    }
                }
                this.state.eventListeners = {};
            },

            /**
             * Binds a single event listener and stores it for later removal.
             * @param {HTMLElement} element
             * @param {string} event
             * @param {Function} handler
             * @param {string} [id]
             */
            bindEvent: function(element, event, handler, id = `event-${Date.now()}-${Math.random()}`) {
                if (element && handler) {
                    const boundHandler = handler.bind(this);
                    element.addEventListener(event, boundHandler);
                    this.state.eventListeners[id] = { element, event, handler: boundHandler };
                } else {
                    console.warn(`Attempted to bind event to null element or with a null handler:`, { element, handler });
                }
            },

            /**
             * Binds all event listeners for the authentication section.
             */
            bindAuthEvents: function() {
                this.removeListeners(); // Clear previous listeners
                this.bindEvent(this.elements.authForm, 'submit', this.handleAuthSubmit);
                this.bindEvent(this.elements.authToggleLink, 'click', this.toggleAuthMode);
            },

            /**
             * Binds all event listeners for the dashboard section.
             */
            bindDashboardEvents: function() {
                this.removeListeners(); // Clear previous listeners
                this.bindEvent(this.elements.logoutBtn, 'click', this.handleLogout);
                this.bindEvent(this.elements.showCreateServerModalBtn, 'click', this.showCreateServerModal);
                this.bindEvent(this.elements.joinServerBtn, 'click', this.handleJoinServer);
            },

            /**
             * Binds all event listeners for the server panel section.
             */
            bindPanelEvents: function() {
                this.removeListeners(); // Clear previous listeners
                this.bindEvent(this.elements.backToDashboardBtn, 'click', this.showDashboard);
                this.bindEvent(this.elements.panelTabButtons, 'click', this.handleTabSwitch);
                this.bindEvent(this.elements.shiftToggleButton, 'click', this.handleShiftToggle);
                
                // Punishments
                this.bindEvent(this.elements.addPunishmentBtn, 'click', this.handleAddPunishment);
                this.bindEvent(this.elements.punishLookupBtn, 'click', this.handleLookupPunishments);
                this.bindEvent(this.elements.punishShowAllBtn, 'click', this.handleShowAllPunishments);

                // Manual refresh buttons
                this.bindEvent(this.elements.refreshPlayersBtn, 'click', this.refreshPlayers);
                this.bindEvent(this.elements.refreshVehiclesBtn, 'click', this.refreshVehicles);
                this.bindEvent(this.elements.refreshKillLogsBtn, 'click', this.refreshKillLogs);
                this.bindEvent(this.elements.refreshCommandLogsBtn, 'click', this.refreshCommandLogs);
                
                // Shift Wave controls
                this.bindEvent(this.elements.startShiftWaveBtn, 'click', this.handleShiftWaveAction.bind(this, 'start'));
                this.bindEvent(this.elements.endShiftWaveBtn, 'click', this.handleShiftWaveAction.bind(this, 'end'));

                // Commands
                this.bindEvent(this.elements.executeCommandButton, 'click', this.handleExecuteCommand);
                
                // Owner-only
                this.bindEvent(document.getElementById('save-server-name-btn'), 'click', this.handleSaveServerName);
                this.bindEvent(document.getElementById('save-api-key-btn'), 'click', this.handleSaveApiKey);
                this.bindEvent(this.elements.deleteServerBtn, 'click', this.handleDeleteServer);

                // Modals
                this.bindEvent(this.elements.cancelEditPunishmentBtn, 'click', () => this.elements.editPunishmentModal.classList.add('hidden'));
                this.bindEvent(this.elements.editPunishmentForm, 'submit', this.handleEditPunishment);
                
                // Event delegation for dynamically created punishment buttons
                this.bindEvent(this.elements.punishmentsList, 'click', (event) => {
                    const editBtn = event.target.closest('.edit-punishment-btn');
                    const deleteBtn = event.target.closest('.delete-punishment-btn');
                    if (editBtn) {
                        const docId = editBtn.dataset.docId;
                        this.showEditPunishmentModal(docId);
                    } else if (deleteBtn) {
                        const docId = deleteBtn.dataset.docId;
                        this.handleDeletePunishment(docId);
                    }
                });
            },

            // --- AUTHENTICATION METHODS ---
            /**
             * Handles Firebase Auth state changes.
             * This function now only OBSERVES state, it does not perform auth actions.
             * @param {firebase.User} user
             */
            handleAuthStateChange: function(user) {
                this.state.currentUser = user;
                if (user) {
                    this.elements.authSection.classList.add('hidden');
                    this.elements.dashboardSection.classList.remove('hidden');
                    this.elements.userEmailSpan.textContent = user.email || "Anonymous";
                    this.elements.loadingOverlay.classList.add('hidden');
                    this.bindDashboardEvents();
                    this.fetchUserServers();
                } else {
                    this.elements.authSection.classList.remove('hidden');
                    this.elements.dashboardSection.classList.add('hidden');
                    this.elements.serverPanelSection.classList.add('hidden');
                    this.elements.loadingOverlay.classList.add('hidden');
                    this.state.unsubscribeListeners.forEach(unsub => unsub());
                    this.state.unsubscribeListeners = [];
                    clearInterval(this.state.shiftInterval);
                    this.bindAuthEvents();
                }
            },
            
            /**
             * Toggles between login and register modes.
             */
            toggleAuthMode: function() {
                this.state.authMode = this.state.authMode === 'login' ? 'register' : 'login';
                this.elements.authTitle.textContent = this.state.authMode === 'login' ? 'Login to Zappy' : 'Register for Zappy';
                this.elements.authSubmitBtn.textContent = this.state.authMode === 'login' ? 'Login' : 'Register';
                this.elements.authPromptText.textContent = this.state.authMode === 'login' ? 'Don\'t have an account?' : 'Already have an account?';
                this.elements.authToggleLink.textContent = this.state.authMode === 'login' ? 'Register' : 'Login';
                this.elements.authError.textContent = '';
            },

            /**
             * Handles the form submission for both login and register.
             * @param {Event} event
             */
            handleAuthSubmit: async function(event) {
                event.preventDefault();
                const email = this.elements.emailInput.value;
                const password = this.elements.passwordInput.value;
                this.elements.authError.textContent = '';
                
                try {
                    if (this.state.authMode === 'login') {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    this.elements.authError.textContent = error.message;
                }
            },

            // --- SERVER & DATA MANAGEMENT ---
            /**
             * Fetches the user's servers from Firestore.
             */
            fetchUserServers: async function() {
                // ... (unchanged)
            },

            /**
             * Fetches a single server's data and sets up real-time listeners.
             * @param {string} serverId
             */
            enterServerPanel: async function(serverId) {
                this.elements.loadingOverlay.classList.remove('hidden');
                this.elements.dashboardSection.classList.add('hidden');
                this.elements.serverPanelSection.classList.remove('hidden');
                this.bindPanelEvents(); // Bind panel-specific events

                const serverRef = doc(db, `/artifacts/${appId}/public/data/servers/${serverId}`);

                try {
                    const docSnap = await getDoc(serverRef);
                    if (docSnap.exists()) {
                        this.state.currentServer = { id: serverId, ...docSnap.data() };
                        this.state.isOwner = this.state.currentServer.ownerId === this.state.currentUser.uid;
                        this.updateServerPanelUI();
                        this.setupRealtimeListeners();
                        this.elements.loadingOverlay.classList.add('hidden');
                    } else {
                        console.error("Server not found!");
                        this.showDashboard();
                    }
                } catch (e) {
                    console.error("Error fetching server data:", e);
                    this.showDashboard();
                }
            },

            /**
             * Sets up real-time Firestore listeners for the current server.
             */
            setupRealtimeListeners: function() {
                // Cleanup existing listeners first
                this.state.unsubscribeListeners.forEach(unsub => unsub());
                this.state.unsubscribeListeners = [];

                const serverRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}`);

                // Listener for server details
                this.state.unsubscribeListeners.push(onSnapshot(serverRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.state.currentServer = { id: docSnap.id, ...docSnap.data() };
                        this.updateServerPanelUI();
                    } else {
                        this.showDashboard();
                    }
                }));

                // Listener for players
                this.state.unsubscribeListeners.push(onSnapshot(collection(serverRef, "players"), (querySnapshot) => {
                    const players = [];
                    const queue = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        data.isQueued ? queue.push(data) : players.push(data);
                    });
                    this.displayPlayers(players, queue);
                }));

                // Listener for kill logs
                this.state.unsubscribeListeners.push(onSnapshot(collection(serverRef, "killlogs"), (querySnapshot) => {
                    const logs = [];
                    querySnapshot.forEach(doc => logs.push(doc.data()));
                    this.displayKillLogs(logs);
                }));

                // Listener for vehicles
                this.state.unsubscribeListeners.push(onSnapshot(collection(serverRef, "vehicles"), (querySnapshot) => {
                    const vehicles = [];
                    querySnapshot.forEach(doc => vehicles.push(doc.data()));
                    this.displayVehicles(vehicles);
                }));

                // Listener for punishments
                this.state.unsubscribeListeners.push(onSnapshot(collection(serverRef, "punishments"), (querySnapshot) => {
                    const punishments = [];
                    querySnapshot.forEach(doc => punishments.push({ id: doc.id, ...doc.data() }));
                    this.displayPunishments(punishments);
                }));

                // Listener for server members
                this.state.unsubscribeListeners.push(onSnapshot(collection(serverRef, "members"), (querySnapshot) => {
                    const members = [];
                    querySnapshot.forEach(doc => members.push({ id: doc.id, ...doc.data() }));
                    this.displayServerMembers(members);
                }));

                // Listener for join requests (owner-only)
                if (this.state.isOwner) {
                    this.state.unsubscribeListeners.push(onSnapshot(collection(serverRef, "joinRequests"), (querySnapshot) => {
                        const requests = [];
                        querySnapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                        this.displayJoinRequests(requests);
                    }));
                }
            },

            // --- UI RENDERING & UPDATES ---
            /**
             * Renders player data to the UI.
             * @param {Array} players
             * @param {Array} queue
             */
            displayPlayers: function(players, queue) {
                this.elements.playerCount.textContent = players.length;
                this.elements.queueCount.textContent = queue.length;

                this.elements.playerList.innerHTML = players.map(p => `
                    <li class="p-2 border-b border-slate-700 last:border-b-0 flex items-center justify-between">
                        <div>
                            <span class="font-semibold text-white">${p.username}</span>
                            <span class="text-xs text-slate-500 block">(${p.robloxUserId})</span>
                        </div>
                    </li>
                `).join('');

                this.elements.playerQueue.innerHTML = queue.map(p => `
                    <li class="p-2 border-b border-slate-700 last:border-b-0 flex items-center justify-between">
                        <div>
                            <span class="font-semibold text-white">${p.username}</span>
                            <span class="text-xs text-slate-500 block">(${p.robloxUserId})</span>
                        </div>
                    </li>
                `).join('');
            },

            /**
             * Renders vehicle data to the UI.
             * @param {Array} vehicles
             */
            displayVehicles: function(vehicles) {
                const vehicleList = this.elements.vehicleList;
                vehicleList.innerHTML = '';
                if (vehicles.length === 0) {
                    vehicleList.innerHTML = '<p class="text-center text-slate-400">No vehicle data available.</p>';
                    return;
                }
                const listHtml = vehicles.map(v => `
                    <div class="p-4 border-b border-slate-700 last:border-b-0">
                        <p><span class="font-bold text-white">${v.name}</span> <span class="text-slate-500">(${v.owner})</span></p>
                        <p class="text-sm text-slate-400">Model: ${v.model} | Health: ${v.health}%</p>
                    </div>
                `).join('');
                vehicleList.innerHTML = listHtml;
            },

            /**
             * Renders kill log data to the UI.
             * @param {Array} logs
             */
            displayKillLogs: function(logs) {
                const killLogList = this.elements.killLogList;
                killLogList.innerHTML = '';
                if (logs.length === 0) {
                    killLogList.innerHTML = '<p class="text-center text-slate-400">No kill logs available.</p>';
                    return;
                }
                const listHtml = logs.map(log => {
                    const timestamp = log.timestamp.toDate().toLocaleString();
                    return `<p><span class="text-slate-500">[${timestamp}]</span> <span class="font-semibold text-red-400">${log.killer}</span> killed <span class="font-semibold text-white">${log.victim}</span> with <span class="text-slate-400">${log.weapon}</span>.</p>`;
                }).join('');
                killLogList.innerHTML = listHtml;
            },

            /**
             * Renders punishment data to the UI.
             * @param {Array} punishments
             */
            displayPunishments: function(punishments) {
                const punishmentsList = this.elements.punishmentsList;
                punishmentsList.innerHTML = '';
                if (punishments.length === 0) {
                    punishmentsList.innerHTML = '<p class="text-center text-slate-400">No punishments found.</p>';
                    return;
                }

                // Sorting by timestamp descending
                punishments.sort((a, b) => b.timestamp - a.timestamp);

                const listHtml = punishments.map(p => {
                    const timestamp = p.timestamp.toDate().toLocaleString();
                    const durationText = p.duration ? ` - Duration: ${p.duration} days` : '';
                    return `
                        <div class="p-4 border-b border-slate-700 last:border-b-0 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-white">${p.username}</p>
                                <p class="text-sm text-slate-400">Type: <span class="font-semibold">${p.type}</span></p>
                                <p class="text-sm text-slate-400">Reason: ${p.reason}</p>
                                <p class="text-xs text-slate-500">Issued by: ${p.issuedBy}</p>
                                <p class="text-xs text-slate-500">Date: ${timestamp}${durationText}</p>
                            </div>
                            ${this.state.isOwner ? `
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm edit-punishment-btn" data-doc-id="${p.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                </button>
                                <button class="btn btn-danger btn-sm delete-punishment-btn" data-doc-id="${p.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0-1-1-2-2-2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');
                punishmentsList.innerHTML = listHtml;
            },

            // --- USER INTERACTION HANDLERS ---
            /**
             * Handles tab switching in the server panel.
             * @param {Event} event
             */
            handleTabSwitch: function(event) {
                 const tab = event.target.dataset.tab;
                 if (!tab) return;
                 document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                 document.getElementById(`tab-${tab}`).classList.remove('hidden');
                 document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
                 event.target.classList.add('active');
            },

            /**
             * Handles command execution.
             */
            handleExecuteCommand: async function() {
                if (!this.state.isOwner) {
                    this.elements.commandResponse.textContent = "Error: Only the server owner can execute commands.";
                    this.elements.commandResponse.className = "mt-4 p-3 rounded-md bg-red-900 text-sm";
                    return;
                }
                const command = this.elements.commandInput.value;
                if (!command) return;

                const serverRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}`);
                const commandRef = collection(serverRef, "commandLogs");

                try {
                    await addDoc(commandRef, {
                        command,
                        executedBy: this.state.currentUser.email,
                        timestamp: serverTimestamp()
                    });
                    this.elements.commandResponse.textContent = `Command sent: "${command}". Awaiting response...`;
                    this.elements.commandResponse.className = "mt-4 p-3 rounded-md bg-blue-900 text-sm";
                } catch (e) {
                    this.elements.commandResponse.textContent = `Failed to send command: ${e.message}`;
                    this.elements.commandResponse.className = "mt-4 p-3 rounded-md bg-red-900 text-sm";
                }
            },
            
            /**
             * Functions to manually refresh data, as requested by the user's previous code snippet.
             * These primarily serve as a way to trigger a `getDocs` if real-time listeners are not desired for a specific action.
             */
            refreshPlayers: async function() {
                this.elements.playerList.innerHTML = '<p class="text-center text-slate-400">Refreshing...</p>';
                this.elements.playerQueue.innerHTML = '';
                const playersRef = collection(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/players`);
                const querySnapshot = await getDocs(playersRef);
                const players = [];
                const queue = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    data.isQueued ? queue.push(data) : players.push(data);
                });
                this.displayPlayers(players, queue);
            },

            refreshVehicles: async function() {
                this.elements.vehicleList.innerHTML = '<p class="text-center text-slate-400">Refreshing...</p>';
                const vehiclesRef = collection(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/vehicles`);
                const querySnapshot = await getDocs(vehiclesRef);
                const vehicles = [];
                querySnapshot.forEach(doc => vehicles.push(doc.data()));
                this.displayVehicles(vehicles);
            },

            refreshKillLogs: async function() {
                this.elements.killLogList.innerHTML = '<p class="text-center text-slate-400">Refreshing...</p>';
                const killLogsRef = collection(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/killlogs`);
                const querySnapshot = await getDocs(killLogsRef);
                const logs = [];
                querySnapshot.forEach(doc => logs.push(doc.data()));
                this.displayKillLogs(logs);
            },
            
            refreshCommandLogs: async function() {
                // Not implemented in the original snippet, but included here for completeness
                console.log("Refreshing Command Logs...");
                // Here, you would implement the logic to fetch and display the command logs.
                // For now, this is a placeholder.
            },
            
            /**
             * Handles starting or ending a shift wave.
             * @param {string} action 'start' or 'end'
             */
            handleShiftWaveAction: async function(action) {
                if (!this.state.isOwner) {
                    this.elements.shiftControlsMessage.textContent = "Only the server owner can start or end a shift wave.";
                    this.elements.shiftControlsMessage.className = "text-red-400 text-sm mt-2 text-center";
                    return;
                }
                const serverRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}`);
                
                try {
                    await updateDoc(serverRef, {
                        shiftWaveActive: action === 'start'
                    });
                    this.elements.shiftControlsMessage.textContent = `Shift wave ${action}ed successfully.`;
                    this.elements.shiftControlsMessage.className = "text-green-400 text-sm mt-2 text-center";
                } catch (e) {
                    this.elements.shiftControlsMessage.textContent = `Failed to ${action} shift wave.`;
                    this.elements.shiftControlsMessage.className = "text-red-400 text-sm mt-2 text-center";
                }
            },

            /**
             * Handles adding a new punishment.
             */
            handleAddPunishment: async function() {
                const username = this.elements.punishUsernameInput.value.trim();
                const type = this.elements.punishTypeSelect.value;
                const reason = this.elements.punishReasonInput.value.trim();
                const duration = type === 'Temp Ban' ? parseInt(this.elements.punishDurationInput.value, 10) : null;

                if (!username || !type || !reason) {
                    this.displayModal("Error", "Username, type, and reason are required.", "Close", () => {});
                    return;
                }

                try {
                    const serverRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}`);
                    await addDoc(collection(serverRef, "punishments"), {
                        username,
                        type,
                        reason,
                        duration,
                        issuedBy: this.state.currentUser.email,
                        timestamp: serverTimestamp()
                    });
                    this.elements.punishUsernameInput.value = '';
                    this.elements.punishTypeSelect.value = '';
                    this.elements.punishReasonInput.value = '';
                    this.elements.punishDurationInput.value = '';
                    this.displayModal("Success", "Punishment added successfully!", "OK", () => {});
                } catch (e) {
                    console.error("Error adding punishment:", e);
                    this.displayModal("Error", "Failed to add punishment. Please try again.", "Close", () => {});
                }
            },

            /**
             * Handles lookup of punishments by username.
             */
            handleLookupPunishments: async function() {
                const username = this.elements.punishLookupInput.value.trim();
                const punishmentsList = this.elements.punishmentsList;

                if (!username) {
                    this.displayModal("Error", "Please enter a username to lookup.", "Close", () => {});
                    return;
                }

                punishmentsList.innerHTML = '<p class="text-center text-slate-400">Searching...</p>';

                try {
                    const punishmentsRef = collection(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishments`);
                    const q = query(punishmentsRef, where("username", "==", username));
                    const querySnapshot = await getDocs(q);

                    const punishments = [];
                    querySnapshot.forEach(doc => punishments.push({ id: doc.id, ...doc.data() }));

                    this.displayPunishments(punishments);
                } catch (e) {
                    console.error("Error looking up punishments:", e);
                    punishmentsList.innerHTML = '<p class="text-center text-red-400">Failed to lookup punishments.</p>';
                }
            },

            /**
             * Handles the display of all punishments.
             */
            handleShowAllPunishments: async function() {
                 this.elements.punishLookupInput.value = ''; // Clear the lookup input
                 this.elements.punishmentsList.innerHTML = '<p class="text-center text-slate-400">Loading all punishments...</p>';
                 try {
                     const punishmentsRef = collection(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishments`);
                     const querySnapshot = await getDocs(punishmentsRef);

                     const punishments = [];
                     querySnapshot.forEach(doc => punishments.push({ id: doc.id, ...doc.data() }));

                     this.displayPunishments(punishments);
                 } catch (e) {
                     console.error("Error fetching all punishments:", e);
                     this.elements.punishmentsList.innerHTML = '<p class="text-center text-red-400">Failed to load punishments.</p>';
                 }
            },

            /**
             * Displays the edit punishment modal.
             * @param {string} docId
             */
            showEditPunishmentModal: async function(docId) {
                try {
                    const punishmentRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishments/${docId}`);
                    const docSnap = await getDoc(punishmentRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.elements.editPunishmentDocId.value = docId;
                        this.elements.editPunishUsername.value = data.username;
                        this.elements.editPunishType.value = data.type;
                        this.elements.editPunishReason.value = data.reason;
                        this.elements.editPunishDuration.value = data.duration || '';
                        this.elements.editPunishmentModal.classList.remove('hidden');
                    } else {
                        this.displayModal("Error", "Punishment not found.", "Close", () => {});
                    }
                } catch (e) {
                    console.error("Error fetching punishment for edit:", e);
                    this.displayModal("Error", "Failed to load punishment data.", "Close", () => {});
                }
            },

            /**
             * Handles saving changes to a punishment.
             */
            handleEditPunishment: async function(event) {
                event.preventDefault();
                const docId = this.elements.editPunishmentDocId.value;
                const username = this.elements.editPunishUsername.value.trim();
                const type = this.elements.editPunishType.value;
                const reason = this.elements.editPunishReason.value.trim();
                const duration = type === 'Temp Ban' ? parseInt(this.elements.editPunishDuration.value, 10) : null;

                if (!username || !type || !reason || !docId) {
                    this.displayModal("Error", "All fields are required.", "Close", () => {});
                    return;
                }

                try {
                    const punishmentRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishments/${docId}`);
                    await updateDoc(punishmentRef, {
                        username,
                        type,
                        reason,
                        duration
                    });
                    this.elements.editPunishmentModal.classList.add('hidden');
                    this.displayModal("Success", "Punishment updated successfully!", "OK", () => {});
                } catch (e) {
                    console.error("Error updating punishment:", e);
                    this.displayModal("Error", "Failed to update punishment. Please try again.", "Close", () => {});
                }
            },

            /**
             * Handles deleting a punishment.
             * @param {string} docId
             */
            handleDeletePunishment: async function(docId) {
                const confirmed = await this.showConfirmation("Delete Punishment", "Are you sure you want to delete this punishment? This cannot be undone.");
                if (confirmed) {
                    try {
                        const punishmentRef = doc(db, `/artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishments/${docId}`);
                        await deleteDoc(punishmentRef);
                        this.displayModal("Success", "Punishment deleted.", "OK", () => {});
                    } catch (e) {
                        console.error("Error deleting punishment:", e);
                        this.displayModal("Error", "Failed to delete punishment. Please try again.", "Close", () => {});
                    }
                }
            },

            // --- APP INITIALIZATION ---
            init: function() {
                this.cacheElements();

                // This is the correct way to handle auth. We set up the listener to react to any auth state changes.
                // The listener will fire immediately with the current state (either a user or null).
                onAuthStateChanged(auth, this.handleAuthStateChange.bind(this));
            },
        };

        // Initialize the app when the DOM is fully loaded
        window.onload = () => {
            ZappyApp.init();
        };
    </script>
</body>
</html>
