<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappy | Dashboard</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons - Although the original was lucide-react, we'll use inline SVGs or simpler icons for plain HTML/JS -->
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #cbd5e1; /* Slate 300 */
        }
        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #e2e8f0; /* Slate 200 */
        }
        .btn-secondary:hover {
            background-color: #475569; /* Slate 600 */
        }
        .btn-danger {
            background-color: #dc2626; /* Red 600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* Red 700 */
        }
        .form-input {
            width: 100%;
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            color: #f1f5f9; /* Slate 100 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 2px #312e81; /* Indigo 800 */
        }
        .hidden {
            display: none !important; /* Use !important to override Tailwind's flex/block etc. */
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
        }
        .log-box {
            background-color: #0f172a;
            border: 1px solid #334155;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8); /* Slate 900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- App Container -->
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden max-w-md mx-auto">
            <div class="card">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-6">Login to Zappy</h2>
                <form id="auth-form">
                    <div class="mb-4" id="username-field" style="display: none;">
                        <label for="username" class="block mb-2 text-sm font-medium text-slate-400">Username</label>
                        <input type="text" id="username" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block mb-2 text-sm font-medium text-slate-400">Username (Email)</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2 text-sm font-medium text-slate-400">Password</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <p id="auth-error" class="text-red-400 text-sm mb-4 text-center"></p>
                    <button id="auth-submit-btn" type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p class="text-center text-sm text-slate-400 mt-6">
                    <span id="auth-prompt-text">Don't have an account?</span>
                    <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-400 hover:text-indigo-300">Register</a>
                </p>
            </div>
        </div>

        <!-- Main Dashboard Section (Post-Login) -->
        <div id="dashboard-section" class="hidden">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Your Servers</h1>
                    <p class="text-slate-400">Manage your servers or join a new one.</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-slate-300"></span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </header>

            <!-- Server Interaction -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Create a New Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Use your ER:LC Server API Key to create and manage a server group.</p>
                    <button id="show-create-server-modal-btn" class="btn btn-primary">Create Server</button>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Join a Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Enter a server code provided by a server owner to request access.</p>
                    <div class="flex gap-2">
                        <input type="text" id="join-code-input" placeholder="Enter Server Code" class="form-input">
                        <button id="join-server-btn" class="btn btn-secondary">Join</button>
                    </div>
                     <p id="join-server-error" class="text-red-400 text-sm mt-2 text-center"></p>
                     <p id="join-server-success" class="text-green-400 text-sm mt-2 text-center"></p>
                </div>
            </div>

            <!-- Server List -->
            <div>
                <h2 class="text-2xl font-bold text-white mb-4">Server List</h2>
                <div id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Server cards will be injected here -->
                </div>
                 <p id="server-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
            </div>
        </div>

        <!-- Server Panel Section (Selected Server) -->
        <div id="server-panel-section" class="hidden">
            <!-- Panel Header -->
            <header class="mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <button id="back-to-dashboard-btn" class="btn btn-secondary mb-4">&larr; Back to Dashboard</button>
                        <h1 id="panel-server-name" class="text-3xl font-bold text-white">Server Name</h1>
                        <p id="panel-server-code" class="text-slate-400 font-mono"></p>
                    </div>
                    <div id="shift-controls" class="card p-4 flex items-center gap-4">
                        <p class="text-slate-300">Your Shift: <span id="shift-timer" class="font-mono">00:00:00</span></p>
                        <button id="shift-toggle-btn" class="btn btn-primary">Start Shift</button>
                         <p id="shift-controls-message" class="text-sm mt-2 text-center"></p>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="mb-6">
                <div id="panel-tab-buttons" class="flex flex-wrap items-center gap-2 border-b border-slate-700 pb-2">
                    <button class="tab-button btn btn-secondary active" data-tab="main">Server Info</button>
                    <button class="tab-button btn btn-secondary" data-tab="players">Players</button>
                    <button class="tab-button btn btn-secondary" data-tab="vehicles">Vehicles</button>
                    <button class="tab-button btn btn-secondary" data-tab="killlogs">Kill Logs</button>
                    <button class="tab-button btn btn-secondary" data-tab="commands">Execute</button>
                    <button class="tab-button btn btn-secondary" data-tab="shifts">Shifts</button>
                    <button class="tab-button btn btn-secondary" data-tab="punishments">Punishments</button>
                    <!-- Owner-only tab is added dynamically -->
                </div>
            </div>

            <!-- Tab Content -->
            <div id="panel-tab-content">
                <!-- Main Info Tab -->
                <div id="tab-main" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Server Statistics</h3>
                            <button id="refresh-stats-btn" class="btn btn-secondary btn-sm mb-4">Refresh Stats</button>
                            <div id="server-stats-output">Loading...</div>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Real-time Events</h3>
                            <div id="log-output" class="log-box">Connecting...</div>
                        </div>
                    </div>
                </div>

                <!-- Players Tab -->
                <div id="tab-players" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Players & Queue</h3>
                        <button id="refresh-players-btn" class="btn btn-secondary btn-sm mb-4">Refresh Players</button>
                        <p class="mb-4">Online: <span id="player-count">0</span> | Queue: <span id="queue-count">0</span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold mb-2">Online Players</h4>
                                <ul id="player-list" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Queued Players</h4>
                                <ul id="player-queue" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Join Requests</h4>
                                <ul id="join-requests-display" class="log-box"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicles Tab -->
                <div id="tab-vehicles" class="tab-content card hidden">
                    <h3 class="text-xl font-semibold mb-4 text-white">Vehicle Data</h3>
                    <p class="text-slate-400 mb-4">Vehicle data would be displayed here.</p>
                    <button id="refresh-vehicles-btn" class="btn btn-secondary btn-sm mb-4">Refresh Vehicles</button>
                    <div id="vehicle-list" class="log-box">Loading vehicle data...</div>
                </div>

                <!-- Kill Logs Tab -->
                <div id="tab-killlogs" class="tab-content card hidden">
                    <h3 class="text-xl font-semibold mb-4 text-white">Kill Logs</h3>
                    <p class="text-slate-400 mb-4">Kill logs would be displayed here.</p>
                    <button id="refresh-killlogs-btn" class="btn btn-secondary btn-sm mb-4">Refresh Kill Logs</button>
                    <div id="kill-log-list" class="log-box">Loading kill logs...</div>
                </div>

                <!-- Commands Tab -->
                <div id="tab-commands" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Execute Command</h3>
                        <p class="text-slate-400 mb-4 text-sm">Enter a command to execute on the ER:LC server. Owner-only.</p>
                        <div class="flex gap-2">
                            <input type="text" id="command-input" placeholder="e.g., :kick PlayerName" class="form-input">
                            <button id="execute-command-button" class="btn btn-primary">Execute</button>
                        </div>
                        <div id="command-response" class="mt-4 p-3 rounded-md bg-slate-900 text-sm"></div>
                    </div>
                </div>

                <!-- Shifts Tab -->
                <div id="tab-shifts" class="tab-content hidden">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Shift Leaderboard</h3>
                            <div id="shift-wave-controls">
                                <!-- Owner-only controls added here -->
                                <button id="start-shift-wave-btn" class="btn btn-primary btn-sm hidden">Start Shift Wave</button>
                                <button id="end-shift-wave-btn" class="btn btn-danger btn-sm hidden">End Shift Wave</button>
                            </div>
                        </div>
                        <div id="shift-leaderboard" class="space-y-2">Loading...</div>
                    </div>
                </div>

                <!-- Punishments Tab -->
                <div id="tab-punishments" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Add Punishment</h3>
                            <form id="add-punishment-form">
                                <div class="mb-4">
                                    <label for="punish-username" class="block mb-2 text-sm font-medium">Roblox Username</label>
                                    <input type="text" id="punish-username" class="form-input" required placeholder="Roblox User">
                                </div>
                                <div class="mb-4">
                                    <label for="punish-reason" class="block mb-2 text-sm font-medium">Reason</label>
                                    <input type="text" id="punish-reason" class="form-input" required placeholder="Exploiting, Trolling, etc.">
                                </div>
                                <div class="mb-4">
                                    <label for="punish-type" class="block mb-2 text-sm font-medium">Punishment Type</label>
                                    <select id="punish-type" class="form-input" required>
                                        <option value="kick">Kick</option>
                                        <option value="warn">Warn</option>
                                        <option value="ban">Ban</option>
                                        <option value="temp ban">Temporary Ban</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-full">Add Punishment</button>
                            </form>
                            <p id="add-punishment-message" class="text-red-400 text-sm mt-2 text-center"></p>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Punishment Lookup & History</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="lookup-username" placeholder="Search Roblox Username" class="form-input">
                                <button id="lookup-punishments-btn" class="btn btn-secondary">Search</button>
                            </div>
                            <div id="punishment-list" class="log-box">No punishments to display.</div>
                        </div>
                    </div>
                </div>

                <!-- Owner Admin Tab -->
                <div id="tab-owner" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Join Requests</h3>
                            <div id="owner-join-requests-list" class="space-y-3">No pending requests.</div>
                             <p id="owner-join-requests-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Manage Server Members</h3>
                            <div id="server-members-list" class="log-box mb-4">No members to display.</div>
                             <p id="server-members-message" class="text-sm mt-2 text-center"></p>
                            <hr class="border-slate-700 my-6">
                            <h3 class="text-xl font-semibold text-white mb-4">Server Settings</h3>
                            <p class="text-slate-400 text-sm mb-4">Only the server name can be changed after creation. The server code is permanently linked to the server's database ID.</p>
                            <label for="edit-server-name" class="block mb-2">Server Name</label>
                            <input type="text" id="edit-server-name" class="form-input mb-4">
                            <button id="save-server-name-btn" class="btn btn-primary">Save Name</button>
                             <p id="owner-settings-success" class="text-green-400 text-sm mt-2 text-center"></p>
                             <p id="owner-settings-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <label for="edit-api-key" class="block mb-2">ER:LC Server API Key</label>
                            <input type="password" id="edit-api-key" class="form-input mb-4">
                            <button id="save-api-key-btn" class="btn btn-primary">Save API Key</button>
                            <p id="owner-api-key-success" class="text-green-400 text-sm mt-2 text-center"></p>
                            <p id="owner-api-key-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <h4 class="font-semibold text-red-400 mb-2">Danger Zone</h4>
                            <button id="delete-server-btn" class="btn btn-danger">Delete Server</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="create-server-modal" class="modal-overlay hidden">
        <div class="card max-w-lg w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Create Server</h2>
            <form id="create-server-form">
                <div class="mb-4">
                    <label for="server-name" class="block mb-2 text-sm font-medium">Server Name</label>
                    <input type="text" id="server-name" class="form-input" required placeholder="My Awesome Community">
                </div>
                <div class="mb-4">
                    <label for="server-code" class="block mb-2 text-sm font-medium">Server Code</label>
                    <input type="text" id="server-code" class="form-input" required placeholder="A unique code for users to join">
                    <p class="text-xs text-slate-400 mt-1">This must be unique across all of Zappy.</p>
                </div>
                <div class="mb-6">
                    <label for="api-key" class="block mb-2 text-sm font-medium">ER:LC Server API Key</label>
                    <input type="password" id="api-key" class="form-input" required>
                    <p class="text-xs text-yellow-400 mt-1">Your key is stored securely and is not shared with server members.</p>
                </div>
                <p id="create-server-error" class="text-red-400 text-sm mb-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-create-server-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Modal for Confirmations -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="card max-w-sm w-full text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Punishment Edit Modal -->
    <div id="edit-punishment-modal" class="modal-overlay hidden">
        <div class="card max-w-lg w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Edit Punishment</h2>
            <form id="edit-punishment-form">
                <input type="hidden" id="edit-punishment-id">
                <div class="mb-4">
                    <label for="edit-punish-username" class="block mb-2 text-sm font-medium">Roblox Username</label>
                    <input type="text" id="edit-punish-username" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-punish-reason" class="block mb-2 text-sm font-medium">Reason</label>
                    <input type="text" id="edit-punish-reason" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-punish-type" class="block mb-2 text-sm font-medium">Punishment Type</label>
                    <select id="edit-punish-type" class="form-input" required>
                        <option value="kick">Kick</option>
                        <option value="warn">Warn</option>
                        <option value="ban">Ban</option>
                        <option value="temp ban">Temporary Ban</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-edit-punishment-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
            <p id="edit-punishment-message" class="text-red-400 text-sm mt-2 text-center"></p>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Use __firebase_config and __app_id if available, otherwise fallback to provided config
        const firebaseConfig = {
            apiKey: "AIzaSyCF5bqrinHuV81qTrcoIerlIZAnenvspsw",
            authDomain: "zappyerlc.firebaseapp.com",
            projectId: "zappyerlc",
            storageBucket: "zappyerlc.firebasestorage.app",
            messagingSenderId: "133579238168",
            appId: "1:133579238168:web:00ff14f7c2014ae2164c6d",
            measurementId: "G-K4LDYN8L3E"
        };
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use default-app-id for local testing

        // Import statements - updated to 11.9.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, updateDoc, deleteDoc, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // --- UTILITIES ---
        const showError = (element, message) => {
            element.textContent = message;
            element.style.display = 'block';
        };

        const showSuccess = (element, message) => {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        };

        const toggleModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.toggle('hidden', !show);
            }
        };

        const showLoading = (show) => {
            ZappyApp.elements.loadingOverlay.style.display = show ? 'flex' : 'none';
        };

        const showConfirmation = (title, text, onConfirm) => {
            const modal = ZappyApp.elements.confirmModal;
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

            confirmBtn.onclick = () => {
                onConfirm();
                toggleModal('confirm-modal', false);
            };

            cancelBtn.onclick = () => {
                toggleModal('confirm-modal', false);
            };

            toggleModal('confirm-modal', true);
        };

        // --- ZappyApp ---
        const ZappyApp = {
            state: {
                currentUser: null,
                currentServer: null,
                shiftInterval: null,
                shiftStartTime: null,
                shiftTimerRunning: false,
                unsubscribeListeners: [],
                isOwner: false,
                isAuthReady: false,
            },
            elements: {
                loadingOverlay: document.getElementById('loading-overlay'),
                authSection: document.getElementById('auth-section'),
                dashboardSection: document.getElementById('dashboard-section'),
                serverPanelSection: document.getElementById('server-panel-section'),
                createServerModal: document.getElementById('create-server-modal'),
                confirmModal: document.getElementById('confirm-modal'),
                editPunishmentModal: document.getElementById('edit-punishment-modal'),
                // Dashboard Elements
                serverList: document.getElementById('server-list'),
                userEmailSpan: document.getElementById('user-email'),
                joinServerError: document.getElementById('join-server-error'),
                joinServerSuccess: document.getElementById('join-server-success'),
                serverListError: document.getElementById('server-list-error'),
                // Panel Elements
                panelServerName: document.getElementById('panel-server-name'),
                panelServerCode: document.getElementById('panel-server-code'),
                shiftTimer: document.getElementById('shift-timer'),
                shiftToggleButton: document.getElementById('shift-toggle-btn'),
                panelTabButtons: document.getElementById('panel-tab-buttons'),
                panelTabContent: document.getElementById('panel-tab-content'),
                logOutput: document.getElementById('log-output'),
                serverStatsOutput: document.getElementById('server-stats-output'),
                playerList: document.getElementById('player-list'),
                playerQueue: document.getElementById('player-queue'),
                joinRequestsDisplay: document.getElementById('join-requests-display'),
                refreshPlayersBtn: document.getElementById('refresh-players-btn'),
                refreshVehiclesBtn: document.getElementById('refresh-vehicles-btn'),
                refreshKillLogsBtn: document.getElementById('refresh-killlogs-btn'),
                executeCommandButton: document.getElementById('execute-command-button'),
                commandInput: document.getElementById('command-input'),
                commandResponse: document.getElementById('command-response'),
                vehicleList: document.getElementById('vehicle-list'),
                killLogList: document.getElementById('kill-log-list'),
                addPunishmentForm: document.getElementById('add-punishment-form'),
                punishmentList: document.getElementById('punishment-list'),
                lookupUsernameInput: document.getElementById('lookup-username'),
                lookupPunishmentsBtn: document.getElementById('lookup-punishments-btn'),
                addPunishmentMessage: document.getElementById('add-punishment-message'),
                editPunishmentForm: document.getElementById('edit-punishment-form'),
                cancelEditPunishmentBtn: document.getElementById('cancel-edit-punishment-btn'),
                // Other elements from old code
                startShiftWaveBtn: document.getElementById('start-shift-wave-btn'),
                endShiftWaveBtn: document.getElementById('end-shift-wave-btn'),
                ownerJoinRequestsList: document.getElementById('owner-join-requests-list'),
                serverMembersList: document.getElementById('server-members-list'),
                deleteServerBtn: document.getElementById('delete-server-btn'),
                showCreateServerModalBtn: document.getElementById('show-create-server-modal-btn'),
                createServerForm: document.getElementById('create-server-form'),
                joinServerBtn: document.getElementById('join-server-btn'),
                joinCodeInput: document.getElementById('join-code-input'),
                backToDashboardBtn: document.getElementById('back-to-dashboard-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                shiftLeaderboard: document.getElementById('shift-leaderboard'),
                shiftControls: document.getElementById('shift-controls'),
            },

            init() {
                this.setupAuthListener();
                this.setupGlobalListeners();
            },

            setupAuthListener() {
                onAuthStateChanged(auth, async (user) => {
                    this.state.isAuthReady = true;
                    if (user) {
                        this.state.currentUser = user;
                        this.elements.authSection.classList.add('hidden');
                        this.elements.dashboardSection.classList.remove('hidden');
                        this.elements.userEmailSpan.textContent = user.email;
                        this.loadServerList();
                    } else {
                         // Sign in anonymously if no user is found
                        await signInAnonymously(auth);
                    }
                    showLoading(false);
                });

                if (typeof __initial_auth_token !== 'undefined') {
                    signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
                        console.error("Custom token sign-in failed:", error);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }
            },

            setupGlobalListeners() {
                // Auth listeners
                document.getElementById('auth-form').addEventListener('submit', (e) => this.handleAuthFormSubmit(e));
                document.getElementById('auth-toggle-link').addEventListener('click', (e) => this.handleAuthToggle(e));

                // Dashboard listeners
                this.elements.showCreateServerModalBtn.addEventListener('click', () => toggleModal('create-server-modal', true));
                document.getElementById('cancel-create-server-btn').addEventListener('click', () => toggleModal('create-server-modal', false));
                this.elements.createServerForm.addEventListener('submit', (e) => this.handleCreateServer(e));
                this.elements.joinServerBtn.addEventListener('click', () => this.handleJoinServer());
                this.elements.logoutBtn.addEventListener('click', () => this.handleLogout());
                this.elements.backToDashboardBtn.addEventListener('click', () => this.showDashboard());
                this.elements.deleteServerBtn.addEventListener('click', () => this.handleDeleteServer());
            },

            setupPanelListeners() {
                // Remove any previous listeners
                this.state.unsubscribeListeners.forEach(unsubscribe => unsubscribe());
                this.state.unsubscribeListeners = [];

                // Re-add panel-specific listeners
                this.elements.panelTabButtons.addEventListener('click', (e) => this.handleTabClick(e));
                this.elements.shiftToggleButton.addEventListener('click', () => this.handleShiftToggle());
                document.getElementById('refresh-stats-btn').addEventListener('click', this.refreshStats.bind(this));
                this.elements.refreshPlayersBtn.addEventListener('click', this.refreshPlayers.bind(this));
                this.elements.refreshVehiclesBtn.addEventListener('click', this.refreshVehicles.bind(this));
                this.elements.refreshKillLogsBtn.addEventListener('click', this.refreshKillLogs.bind(this));
                this.elements.executeCommandButton.addEventListener('click', this.handleExecuteCommand.bind(this));
                this.elements.addPunishmentForm.addEventListener('submit', (e) => this.handleAddPunishment(e));
                this.elements.lookupPunishmentsBtn.addEventListener('click', () => this.handleLookupPunishments());
                this.elements.cancelEditPunishmentBtn.addEventListener('click', () => toggleModal('edit-punishment-modal', false));
                this.elements.editPunishmentForm.addEventListener('submit', (e) => this.handleEditPunishment(e));
            },

            // --- AUTH FUNCTIONS ---
            async handleAuthFormSubmit(e) {
                e.preventDefault();
                showLoading(true);
                const isRegister = document.getElementById('auth-submit-btn').textContent === 'Register';
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const username = document.getElementById('username').value;
                const errorElement = document.getElementById('auth-error');
                errorElement.textContent = '';

                try {
                    if (isRegister) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        // Save username to Firestore
                        await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}`), {
                            username: username,
                            email: email,
                            createdAt: serverTimestamp(),
                        });
                        showSuccess(errorElement, "Registration successful! You can now log in.");
                        document.getElementById('auth-submit-btn').textContent = 'Login';
                        document.getElementById('auth-prompt-text').textContent = "Already have an account?";
                        document.getElementById('auth-title').textContent = "Login to Zappy";
                        document.getElementById('username-field').style.display = 'none';
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    showError(errorElement, error.message);
                } finally {
                    showLoading(false);
                }
            },

            handleAuthToggle(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('auth-submit-btn');
                const promptText = document.getElementById('auth-prompt-text');
                const title = document.getElementById('auth-title');
                const usernameField = document.getElementById('username-field');
                const isRegister = submitBtn.textContent === 'Register';

                if (isRegister) {
                    submitBtn.textContent = 'Login';
                    promptText.textContent = "Don't have an account?";
                    title.textContent = "Login to Zappy";
                    usernameField.style.display = 'none';
                } else {
                    submitBtn.textContent = 'Register';
                    promptText.textContent = "Already have an account?";
                    title.textContent = "Register for Zappy";
                    usernameField.style.display = 'block';
                }
            },

            async handleLogout() {
                try {
                    await signOut(auth);
                    this.state.currentUser = null;
                    this.state.currentServer = null;
                    this.elements.serverPanelSection.classList.add('hidden');
                    this.elements.dashboardSection.classList.add('hidden');
                    this.elements.authSection.classList.remove('hidden');
                    this.state.unsubscribeListeners.forEach(unsubscribe => unsubscribe());
                    this.state.unsubscribeListeners = [];
                } catch (error) {
                    console.error("Logout error:", error);
                }
            },

            // --- SERVER DASHBOARD FUNCTIONS ---
            async loadServerList() {
                showLoading(true);
                this.elements.serverList.innerHTML = '';
                try {
                    const serversRef = collection(db, `artifacts/${appId}/public/data/servers`);
                    const q = query(serversRef, where('members', 'array-contains', this.state.currentUser.uid));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        this.elements.serverList.innerHTML = `<p class="text-slate-400">You are not a member of any servers. Create one or join one!</p>`;
                    } else {
                        querySnapshot.forEach((doc) => {
                            const server = doc.data();
                            this.renderServerCard(server, doc.id);
                        });
                    }
                } catch (error) {
                    showError(this.elements.serverListError, "Failed to load server list. Please try again.");
                    console.error("Error loading server list:", error);
                } finally {
                    showLoading(false);
                }
            },

            renderServerCard(server, serverId) {
                const cardHtml = `
                    <div class="card cursor-pointer hover:bg-slate-700 transition" data-server-id="${serverId}">
                        <h3 class="text-xl font-semibold text-white">${server.name}</h3>
                        <p class="text-slate-400">Code: ${server.code}</p>
                        <p class="text-slate-400 text-sm">Owner: ${server.ownerId === this.state.currentUser.uid ? 'You' : 'Other'}</p>
                    </div>
                `;
                const cardContainer = document.createElement('div');
                cardContainer.innerHTML = cardHtml;
                const card = cardContainer.firstChild;
                card.addEventListener('click', () => this.showServerPanel(server, serverId));
                this.elements.serverList.appendChild(card);
            },

            async handleCreateServer(e) {
                e.preventDefault();
                showLoading(true);
                const serverName = document.getElementById('server-name').value;
                const serverCode = document.getElementById('server-code').value;
                const apiKey = document.getElementById('api-key').value;
                const errorElement = document.getElementById('create-server-error');

                try {
                    // Check if server code already exists
                    const serversRef = collection(db, `artifacts/${appId}/public/data/servers`);
                    const q = query(serversRef, where('code', '==', serverCode));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        throw new Error("This server code already exists. Please choose another one.");
                    }

                    const newServerRef = doc(serversRef);
                    await setDoc(newServerRef, {
                        name: serverName,
                        code: serverCode,
                        apiKey: apiKey,
                        ownerId: this.state.currentUser.uid,
                        members: [this.state.currentUser.uid],
                        joinRequests: [],
                        createdAt: serverTimestamp()
                    });

                    toggleModal('create-server-modal', false);
                    this.loadServerList();
                    showSuccess(this.elements.joinServerSuccess, "Server created successfully!");
                } catch (error) {
                    showError(errorElement, error.message);
                    console.error("Error creating server:", error);
                } finally {
                    showLoading(false);
                }
            },

            async handleJoinServer() {
                showLoading(true);
                const joinCode = this.elements.joinCodeInput.value.trim();
                this.elements.joinServerError.textContent = '';
                this.elements.joinServerSuccess.textContent = '';
                if (!joinCode) {
                    showError(this.elements.joinServerError, "Please enter a server code.");
                    showLoading(false);
                    return;
                }

                try {
                    const serversRef = collection(db, `artifacts/${appId}/public/data/servers`);
                    const q = query(serversRef, where('code', '==', joinCode));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        throw new Error("Server not found with that code.");
                    }

                    const serverDoc = querySnapshot.docs[0];
                    await updateDoc(serverDoc.ref, {
                        joinRequests: arrayUnion({ userId: this.state.currentUser.uid, username: await this.getUserUsername(this.state.currentUser.uid) })
                    });

                    showSuccess(this.elements.joinServerSuccess, "Join request sent! Awaiting owner approval.");
                } catch (error) {
                    showError(this.elements.joinServerError, error.message);
                    console.error("Error joining server:", error);
                } finally {
                    showLoading(false);
                }
            },

            // --- SERVER PANEL FUNCTIONS ---
            async showServerPanel(server, serverId) {
                showLoading(true);
                this.state.currentServer = { ...server, id: serverId };
                this.state.isOwner = this.state.currentServer.ownerId === this.state.currentUser.uid;
                this.elements.dashboardSection.classList.add('hidden');
                this.elements.serverPanelSection.classList.remove('hidden');

                // Update UI elements
                this.elements.panelServerName.textContent = server.name;
                this.elements.panelServerCode.textContent = `Server Code: ${server.code}`;

                // Setup owner-only UI
                if (this.state.isOwner) {
                    this.elements.startShiftWaveBtn.classList.remove('hidden');
                    this.elements.endShiftWaveBtn.classList.remove('hidden');
                    // Check for and add owner tab if not present
                    if (!document.querySelector('[data-tab="owner"]')) {
                        const ownerTabBtn = document.createElement('button');
                        ownerTabBtn.className = 'tab-button btn btn-secondary';
                        ownerTabBtn.dataset.tab = 'owner';
                        ownerTabBtn.textContent = 'Owner Admin';
                        this.elements.panelTabButtons.appendChild(ownerTabBtn);
                    }
                } else {
                    this.elements.startShiftWaveBtn.classList.add('hidden');
                    this.elements.endShiftWaveBtn.classList.add('hidden');
                    const ownerTabBtn = document.querySelector('[data-tab="owner"]');
                    if (ownerTabBtn) ownerTabBtn.remove();
                }

                this.setupPanelListeners();
                this.attachRealtimeListeners();
                this.refreshStats(); // Initial data load
                this.refreshPlayers();
                showLoading(false);
            },

            showDashboard() {
                this.elements.serverPanelSection.classList.add('hidden');
                this.elements.dashboardSection.classList.remove('hidden');
                this.state.currentServer = null;
                this.state.unsubscribeListeners.forEach(unsubscribe => unsubscribe());
                this.state.unsubscribeListeners = [];
                this.loadServerList();
            },

            handleTabClick(e) {
                const target = e.target.closest('.tab-button');
                if (!target) return;

                // Deactivate all tabs
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                // Activate selected tab
                target.classList.add('active');
                const tabId = target.dataset.tab;
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            },

            // --- API AND DATA FETCHING FUNCTIONS ---
            async refreshStats() {
                this.elements.serverStatsOutput.innerHTML = 'Fetching server stats...';
                // Placeholder for real API call
                const mockStats = {
                    onlinePlayers: Math.floor(Math.random() * 50),
                    version: "v1.2.3",
                    serverUptime: "2d 4h 15m",
                    serverHealth: "Good",
                };
                setTimeout(() => {
                    this.elements.serverStatsOutput.innerHTML = `
                        <p><strong>Online Players:</strong> ${mockStats.onlinePlayers}</p>
                        <p><strong>Version:</strong> ${mockStats.version}</p>
                        <p><strong>Uptime:</strong> ${mockStats.serverUptime}</p>
                        <p><strong>Health:</strong> <span class="text-green-400">${mockStats.serverHealth}</span></p>
                    `;
                }, 500);
            },

            async refreshPlayers() {
                this.elements.playerList.innerHTML = 'Loading players...';
                this.elements.playerQueue.innerHTML = 'Loading queue...';
                // Placeholder for real API call
                const mockPlayers = [
                    { name: 'JohnDoe', id: '12345' },
                    { name: 'JaneSmith', id: '67890' },
                ];
                const mockQueue = [
                    { name: 'Newbie1', id: '11111' },
                ];
                setTimeout(() => {
                    this.elements.playerList.innerHTML = mockPlayers.map(p => `<li>${p.name} (${p.id})</li>`).join('');
                    this.elements.playerQueue.innerHTML = mockQueue.map(q => `<li>${q.name} (${q.id})</li>`).join('');
                    document.getElementById('player-count').textContent = mockPlayers.length;
                    document.getElementById('queue-count').textContent = mockQueue.length;
                }, 500);
            },

            async refreshVehicles() {
                this.elements.vehicleList.innerHTML = 'Fetching vehicle data...';
                // This is where real API logic would go. A fetch call to the ER:LC API would be here.
                // The code below is a placeholder simulation as the real API is not available.
                try {
                    // This fetch call is a placeholder for a real ER:LC API endpoint.
                    const response = await fetch(`https://api.erlc.com/v1/vehicles?apiKey=${this.state.currentServer.apiKey}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch vehicle data from ER:LC API.');
                    }
                    const vehicles = await response.json();
                    if (vehicles.length > 0) {
                        this.elements.vehicleList.innerHTML = vehicles.map(v => `
                            <li>
                                <strong>${v.model}</strong> - <em>${v.ownerName}</em><br>
                                Position: (${v.x}, ${v.y}, ${v.z})
                            </li>
                        `).join('');
                    } else {
                        this.elements.vehicleList.innerHTML = 'No active vehicles found.';
                    }
                } catch (error) {
                    this.elements.vehicleList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                    console.error("Error fetching vehicles:", error);
                }
            },

            async refreshKillLogs() {
                this.elements.killLogList.innerHTML = 'Fetching kill logs...';
                // This is where real API logic would go. A fetch call to the ER:LC API would be here.
                // The code below is a placeholder simulation as the real API is not available.
                try {
                    // This fetch call is a placeholder for a real ER:LC API endpoint.
                    const response = await fetch(`https://api.erlc.com/v1/killlogs?apiKey=${this.state.currentServer.apiKey}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch kill logs from ER:LC API.');
                    }
                    const killLogs = await response.json();
                    if (killLogs.length > 0) {
                        this.elements.killLogList.innerHTML = killLogs.map(log => `
                            <li>
                                <strong>${new Date(log.timestamp).toLocaleString()}</strong><br>
                                ${log.killerName} killed ${log.victimName} with a ${log.weapon}.
                            </li>
                        `).join('');
                    } else {
                        this.elements.killLogList.innerHTML = 'No kill logs found.';
                    }
                } catch (error) {
                    this.elements.killLogList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                    console.error("Error fetching kill logs:", error);
                }
            },


            // --- COMMANDS ---
            async handleExecuteCommand() {
                const command = this.elements.commandInput.value;
                if (!command) {
                    this.elements.commandResponse.textContent = "Please enter a command.";
                    return;
                }

                // Check if the current user is the owner
                if (!this.state.isOwner) {
                    this.elements.commandResponse.textContent = "Error: You must be the server owner to execute commands.";
                    this.elements.commandResponse.style.color = '#f87171'; // red-400
                    return;
                }

                this.elements.commandResponse.textContent = 'Executing command...';
                this.elements.commandResponse.style.color = '#cbd5e1'; // slate-300

                // Placeholder for real API call
                try {
                    // Assuming a real API endpoint for executing commands
                    const response = await fetch('https://api.erlc.com/v1/execute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.currentServer.apiKey}`
                        },
                        body: JSON.stringify({ command: command })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        this.elements.commandResponse.textContent = `Success: ${result.message}`;
                        this.elements.commandResponse.style.color = '#86efac'; // green-400
                    } else {
                        throw new Error(result.error || 'Failed to execute command.');
                    }
                } catch (error) {
                    this.elements.commandResponse.textContent = `Error: ${error.message}`;
                    this.elements.commandResponse.style.color = '#f87171'; // red-400
                }
            },

            // --- PUNISHMENT SYSTEM ---
            async handleAddPunishment(e) {
                e.preventDefault();
                const username = document.getElementById('punish-username').value;
                const reason = document.getElementById('punish-reason').value;
                const type = document.getElementById('punish-type').value;

                if (!username || !reason || !type) {
                    showError(this.elements.addPunishmentMessage, "All fields are required.");
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/punishments`), {
                        serverId: this.state.currentServer.id,
                        username: username,
                        reason: reason,
                        type: type,
                        punishedBy: this.state.currentUser.uid,
                        timestamp: serverTimestamp(),
                    });
                    showSuccess(this.elements.addPunishmentMessage, "Punishment added successfully.");
                    this.elements.addPunishmentForm.reset();
                } catch (error) {
                    showError(this.elements.addPunishmentMessage, "Failed to add punishment.");
                    console.error("Error adding punishment:", error);
                }
            },

            attachPunishmentsListener() {
                const punishmentsRef = collection(db, `artifacts/${appId}/public/data/punishments`);
                const q = query(punishmentsRef, where('serverId', '==', this.state.currentServer.id));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const punishments = [];
                    snapshot.forEach((doc) => {
                        punishments.push({ id: doc.id, ...doc.data() });
                    });
                    this.renderPunishments(punishments);
                }, (error) => {
                    console.error("Error listening to punishments:", error);
                    this.elements.punishmentList.innerHTML = `<p class="text-red-400">Error loading punishments.</p>`;
                });
                this.state.unsubscribeListeners.push(unsubscribe);
            },

            async handleLookupPunishments() {
                const username = this.elements.lookupUsernameInput.value.trim();
                if (!username) {
                    this.elements.punishmentList.innerHTML = `<p class="text-yellow-400">Please enter a username to search.</p>`;
                    this.attachPunishmentsListener(); // Re-attach all listener
                    return;
                }

                const punishmentsRef = collection(db, `artifacts/${appId}/public/data/punishments`);
                const q = query(punishmentsRef,
                    where('serverId', '==', this.state.currentServer.id),
                    where('username', '==', username));
                const querySnapshot = await getDocs(q);

                const punishments = [];
                querySnapshot.forEach((doc) => {
                    punishments.push({ id: doc.id, ...doc.data() });
                });
                this.renderPunishments(punishments);
            },

            renderPunishments(punishments) {
                this.elements.punishmentList.innerHTML = '';
                if (punishments.length === 0) {
                    this.elements.punishmentList.innerHTML = 'No punishments found.';
                    return;
                }
                punishments.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                punishments.forEach(punishment => {
                    const punishmentItem = document.createElement('div');
                    punishmentItem.className = 'p-3 border-b border-slate-700 last:border-b-0';
                    punishmentItem.innerHTML = `
                        <p class="font-bold text-white">${punishment.username} - <span class="text-red-400">${punishment.type}</span></p>
                        <p class="text-sm">Reason: ${punishment.reason}</p>
                        <p class="text-xs text-slate-500">
                            By: ${punishment.punishedBy.substring(0, 8)}... -
                            ${new Date(punishment.timestamp.seconds * 1000).toLocaleString()}
                        </p>
                        ${this.state.isOwner ? `
                            <div class="mt-2 space-x-2">
                                <button class="btn btn-secondary btn-sm" data-id="${punishment.id}" data-action="edit">Edit</button>
                                <button class="btn btn-danger btn-sm" data-id="${punishment.id}" data-action="delete">Delete</button>
                            </div>
                        ` : ''}
                    `;
                    this.elements.punishmentList.appendChild(punishmentItem);
                });

                if (this.state.isOwner) {
                    document.querySelectorAll('[data-action="edit"]').forEach(btn => {
                        btn.addEventListener('click', (e) => this.showEditPunishmentModal(e.target.dataset.id, punishments));
                    });
                    document.querySelectorAll('[data-action="delete"]').forEach(btn => {
                        btn.addEventListener('click', (e) => this.handleDeletePunishment(e.target.dataset.id));
                    });
                }
            },

            showEditPunishmentModal(punishmentId, punishments) {
                const punishment = punishments.find(p => p.id === punishmentId);
                if (!punishment) return;

                document.getElementById('edit-punishment-id').value = punishment.id;
                document.getElementById('edit-punish-username').value = punishment.username;
                document.getElementById('edit-punish-reason').value = punishment.reason;
                document.getElementById('edit-punish-type').value = punishment.type;

                toggleModal('edit-punishment-modal', true);
            },

            async handleEditPunishment(e) {
                e.preventDefault();
                const punishmentId = document.getElementById('edit-punishment-id').value;
                const username = document.getElementById('edit-punish-username').value;
                const reason = document.getElementById('edit-punish-reason').value;
                const type = document.getElementById('edit-punish-type').value;

                try {
                    const punishmentRef = doc(db, `artifacts/${appId}/public/data/punishments`, punishmentId);
                    await updateDoc(punishmentRef, {
                        username: username,
                        reason: reason,
                        type: type,
                    });
                    toggleModal('edit-punishment-modal', false);
                    showSuccess(this.elements.addPunishmentMessage, "Punishment updated successfully.");
                } catch (error) {
                    showError(this.elements.addPunishmentMessage, "Failed to update punishment.");
                    console.error("Error updating punishment:", error);
                }
            },

            async handleDeletePunishment(punishmentId) {
                showConfirmation(
                    "Delete Punishment?",
                    "Are you sure you want to permanently delete this punishment?",
                    async () => {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/punishments`, punishmentId));
                            showSuccess(this.elements.addPunishmentMessage, "Punishment deleted successfully.");
                        } catch (error) {
                            showError(this.elements.addPunishmentMessage, "Failed to delete punishment.");
                            console.error("Error deleting punishment:", error);
                        }
                    }
                );
            },

            // --- SHIFT FUNCTIONS ---
            startShiftTimer() {
                if (this.state.shiftInterval) return;
                this.state.shiftStartTime = Date.now();
                this.state.shiftTimerRunning = true;
                this.elements.shiftToggleButton.textContent = 'End Shift';
                this.state.shiftInterval = setInterval(() => {
                    const elapsed = Date.now() - this.state.shiftStartTime;
                    const h = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
                    const m = String(Math.floor((elapsed % 3600000) / 60000)).padStart(2, '0');
                    const s = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0');
                    this.elements.shiftTimer.textContent = `${h}:${m}:${s}`;
                }, 1000);
            },

            stopShiftTimer() {
                if (this.state.shiftInterval) {
                    clearInterval(this.state.shiftInterval);
                    this.state.shiftInterval = null;
                    this.state.shiftTimerRunning = false;
                    this.elements.shiftToggleButton.textContent = 'Start Shift';
                }
            },

            handleShiftToggle() {
                if (this.state.shiftTimerRunning) {
                    this.stopShiftTimer();
                } else {
                    this.startShiftTimer();
                }
            },

            // --- REALTIME LISTENERS ---
            async attachRealtimeListeners() {
                if (!this.state.isAuthReady) {
                    // Wait for auth to be ready
                    const unsubscribe = onAuthStateChanged(auth, user => {
                        if (user) {
                            this.attachRealtimeListeners();
                        }
                        unsubscribe();
                    });
                    return;
                }

                // Unsubscribe from any previous listeners
                this.state.unsubscribeListeners.forEach(unsubscribe => unsubscribe());
                this.state.unsubscribeListeners = [];

                // Listen for server info changes
                const serverDocRef = doc(db, `artifacts/${appId}/public/data/servers`, this.state.currentServer.id);
                const unsubscribeServer = onSnapshot(serverDocRef, (doc) => {
                    if (doc.exists()) {
                        const serverData = doc.data();
                        this.state.currentServer = { ...serverData, id: doc.id };
                        this.elements.panelServerName.textContent = serverData.name;
                    } else {
                        // Server was deleted, redirect to dashboard
                        this.showDashboard();
                    }
                });
                this.state.unsubscribeListeners.push(unsubscribeServer);

                // Listen for join requests (owner only)
                if (this.state.isOwner) {
                    const unsubscribeRequests = onSnapshot(serverDocRef, (doc) => {
                        if (doc.exists()) {
                            const requests = doc.data().joinRequests || [];
                            this.renderJoinRequests(requests);
                        }
                    });
                    this.state.unsubscribeListeners.push(unsubscribeRequests);
                }

                // Listen for shift data
                const shiftsRef = collection(db, `artifacts/${appId}/public/data/shifts`);
                const qShifts = query(shiftsRef, where('serverId', '==', this.state.currentServer.id));
                const unsubscribeShifts = onSnapshot(qShifts, (snapshot) => {
                    const shifts = [];
                    snapshot.forEach(doc => shifts.push({ id: doc.id, ...doc.data() }));
                    this.renderShiftLeaderboard(shifts);
                });
                this.state.unsubscribeListeners.push(unsubscribeShifts);

                this.attachPunishmentsListener();
            },

            async renderJoinRequests(requests) {
                this.elements.ownerJoinRequestsList.innerHTML = '';
                this.elements.joinRequestsDisplay.innerHTML = '';

                if (requests.length === 0) {
                    this.elements.ownerJoinRequestsList.innerHTML = `<p class="text-slate-400">No pending requests.</p>`;
                    this.elements.joinRequestsDisplay.innerHTML = `<p class="text-slate-400">No pending requests.</p>`;
                    return;
                }
                
                requests.forEach(request => {
                    const reqHtml = `
                        <div class="p-3 border rounded-lg border-slate-700 flex justify-between items-center">
                            <p class="font-semibold">${request.username} (${request.userId.substring(0, 8)}...)</p>
                            <div class="space-x-2">
                                <button class="btn btn-primary btn-sm accept-request-btn" data-user-id="${request.userId}">Accept</button>
                                <button class="btn btn-danger btn-sm deny-request-btn" data-user-id="${request.userId}">Deny</button>
                            </div>
                        </div>
                    `;
                    const reqElem = document.createElement('div');
                    reqElem.innerHTML = reqHtml;
                    this.elements.ownerJoinRequestsList.appendChild(reqElem.firstChild);
                    this.elements.joinRequestsDisplay.appendChild(reqElem.firstChild.cloneNode(true));
                });
                
                document.querySelectorAll('.accept-request-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleJoinRequest(e.target.dataset.userId, true));
                });
                document.querySelectorAll('.deny-request-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleJoinRequest(e.target.dataset.userId, false));
                });
            },

            async handleJoinRequest(userId, accept) {
                try {
                    const serverRef = doc(db, `artifacts/${appId}/public/data/servers`, this.state.currentServer.id);
                    const batch = writeBatch(db);

                    if (accept) {
                        batch.update(serverRef, {
                            members: arrayUnion(userId)
                        });
                    }
                    
                    const request = { userId: userId, username: await this.getUserUsername(userId) };
                    batch.update(serverRef, {
                        joinRequests: arrayRemove(request)
                    });
                    
                    await batch.commit();
                } catch (error) {
                    console.error("Error handling join request:", error);
                }
            },
            
            async getUserUsername(userId) {
                if (!userId) return 'Unknown User';
                try {
                    const userDoc = await getDoc(doc(db, `artifacts/${appId}/users`, userId));
                    if (userDoc.exists()) {
                        return userDoc.data().username || 'Unknown User';
                    }
                } catch (error) {
                    console.error("Error fetching username:", error);
                }
                return 'Unknown User';
            },

            // --- DANGER ZONE FUNCTIONS ---
            async handleDeleteServer() {
                showConfirmation(
                    "Delete Server?",
                    "This action is permanent and will delete all server data, including member lists, join requests, and shifts. Are you sure?",
                    async () => {
                        showLoading(true);
                        try {
                            const serverRef = doc(db, `artifacts/${appId}/public/data/servers`, this.state.currentServer.id);
                            await deleteDoc(serverRef);
                            this.showDashboard();
                            showSuccess(this.elements.joinServerSuccess, "Server deleted successfully.");
                        } catch (error) {
                            showError(this.elements.joinServerError, "Failed to delete server. Please try again.");
                            console.error("Error deleting server:", error);
                        } finally {
                            showLoading(false);
                        }
                    }
                );
            },
        };

        // Initialize the app when the DOM is fully loaded
        window.onload = () => {
            ZappyApp.init();
        };
    </script>
</body>
</html>
