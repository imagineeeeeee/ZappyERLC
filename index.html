<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappy | Dashboard</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #cbd5e1; /* Slate 300 */
        }
        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #e2e8f0; /* Slate 200 */
        }
        .btn-secondary:hover {
            background-color: #475569; /* Slate 600 */
        }
        .btn-danger {
            background-color: #dc2626; /* Red 600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* Red 700 */
        }
        .form-input, .form-select {
            width: 100%;
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            color: #f1f5f9; /* Slate 100 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 2px #312e81; /* Indigo 800 */
        }
        .hidden {
            display: none !important; /* Use !important to override Tailwind's flex/block etc. */
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
        }
        .log-box {
            background-color: #0f172a;
            border: 1px solid #334155;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8); /* Slate 900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        /* Style for the custom modal */
        #custom-modal {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            z-index: 60;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- App Container -->
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        </div>

        <!-- Custom Modal for Messages/Alerts -->
        <div id="custom-modal-overlay" class="modal-overlay hidden">
            <div id="custom-modal">
                <h3 id="modal-title" class="text-xl font-bold text-white mb-4"></h3>
                <p id="modal-text" class="text-slate-300 mb-6"></p>
                <div id="modal-buttons" class="modal-buttons">
                    <button id="modal-confirm-btn" class="btn btn-primary hidden">Confirm</button>
                    <button id="modal-cancel-btn" class="btn btn-secondary hidden">Cancel</button>
                    <button id="modal-ok-btn" class="btn btn-primary hidden">OK</button>
                </div>
            </div>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden max-w-md mx-auto">
            <div class="card">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-6">Login to Zappy</h2>
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="email" class="block mb-2 text-sm font-medium text-slate-400">Username (Email)</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2 text-sm font-medium text-slate-400">Password</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <p id="auth-error" class="text-red-400 text-sm mb-4 text-center"></p>
                    <button id="auth-submit-btn" type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p class="text-center text-sm text-slate-400 mt-6">
                    <span id="auth-prompt-text">Don't have an account?</span>
                    <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-400 hover:text-indigo-300">Register</a>
                </p>
            </div>
        </div>

        <!-- Main Dashboard Section (Post-Login) -->
        <div id="dashboard-section" class="hidden">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Your Servers</h1>
                    <p class="text-slate-400">Manage your servers or join a new one.</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-slate-300"></span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </header>

            <!-- Server Interaction -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Create a New Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Use your ER:LC Server API Key to create and manage a server group.</p>
                    <button id="show-create-server-modal-btn" class="btn btn-primary">Create Server</button>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Join a Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Enter a server code provided by a server owner to request access.</p>
                    <div class="flex gap-2">
                        <input type="text" id="join-code-input" placeholder="Enter Server Code" class="form-input">
                        <button id="join-server-btn" class="btn btn-secondary">Join</button>
                    </div>
                     <p id="join-server-error" class="text-red-400 text-sm mt-2 text-center"></p>
                     <p id="join-server-success" class="text-green-400 text-sm mt-2 text-center"></p>
                </div>
            </div>

            <!-- Server List -->
            <div>
                <h2 class="text-2xl font-bold text-white mb-4">Server List</h2>
                <div id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Server cards will be injected here -->
                </div>
                 <p id="server-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
            </div>
        </div>

        <!-- Server Panel Section (Selected Server) -->
        <div id="server-panel-section" class="hidden">
            <!-- Panel Header -->
            <header class="mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <button id="back-to-dashboard-btn" class="btn btn-secondary mb-4">&larr; Back to Dashboard</button>
                        <h1 id="panel-server-name" class="text-3xl font-bold text-white">Server Name</h1>
                        <p id="panel-server-code" class="text-slate-400 font-mono"></p>
                    </div>
                    <div id="shift-controls" class="card p-4 flex items-center gap-4">
                        <p class="text-slate-300">Your Shift: <span id="shift-timer" class="font-mono">00:00:00</span></p>
                        <button id="shift-toggle-btn" class="btn btn-primary">Start Shift</button>
                         <p id="shift-controls-message" class="text-sm mt-2 text-center"></p>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="mb-6">
                <div id="panel-tab-buttons" class="flex flex-wrap items-center gap-2 border-b border-slate-700 pb-2">
                    <button class="tab-button btn btn-secondary active" data-tab="main">Server Info</button>
                    <button class="tab-button btn btn-secondary" data-tab="players">Players</button>
                    <button class="tab-button btn btn-secondary" data-tab="commands">Execute</button>
                    <button class="tab-button btn btn-secondary" data-tab="shifts">Shifts</button>
                    <button class="tab-button btn btn-secondary" data-tab="punishments">Punishments</button>
                    <button class="tab-button btn btn-secondary" data-tab="punishment-logs">Punishment Logs</button>
                    <!-- Owner-only tab is added dynamically -->
                </div>
            </div>

            <!-- Tab Content -->
            <div id="panel-tab-content">
                <!-- Main Info Tab -->
                <div id="tab-main" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Server Statistics</h3>
                            <button id="refresh-stats-btn" class="btn btn-secondary btn-sm mb-4">Refresh Stats</button>
                            <div id="server-stats-output">Loading...</div>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Real-time Events</h3>
                            <div id="log-output" class="log-box">Connecting...</div>
                        </div>
                    </div>
                </div>

                <!-- Players Tab -->
                <div id="tab-players" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Players & Queue</h3>
                        <button id="refresh-players-btn" class="btn btn-secondary btn-sm mb-4">Refresh Players</button>
                        <p class="mb-4">Online: <span id="player-count">0</span> | Queue: <span id="queue-count">0</span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold mb-2">Online Players</h4>
                                <ul id="player-list" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Queued Players</h4>
                                <ul id="player-queue" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Join Requests</h4>
                                <ul id="join-requests-display" class="log-box"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Commands Tab -->
                <div id="tab-commands" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Execute Command</h3>
                        <p id="command-permission-text" class="text-yellow-400 text-sm mb-4">This functionality is restricted to the server owner.</p>
                        <div class="flex gap-2">
                            <input type="text" id="command-input" placeholder="e.g., :kick PlayerName" class="form-input" disabled>
                            <button id="execute-command-button" class="btn btn-primary" disabled>Execute</button>
                        </div>
                        <div id="command-response" class="mt-4 p-3 rounded-md bg-slate-900 text-sm"></div>
                    </div>
                </div>

                <!-- Shifts Tab -->
                <div id="tab-shifts" class="tab-content hidden">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Shift Leaderboard</h3>
                            <div id="shift-wave-controls">
                                <!-- Owner-only controls added here -->
                                <button id="start-shift-wave-btn" class="btn btn-primary btn-sm hidden">Start Shift Wave</button>
                                <button id="end-shift-wave-btn" class="btn btn-danger btn-sm hidden">End Shift Wave</button>
                            </div>
                        </div>
                        <div id="shift-leaderboard" class="space-y-2">Loading...</div>
                    </div>
                </div>

                <!-- Punishments Tab -->
                <div id="tab-punishments" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold text-white mb-4">Add New Punishment Log</h3>
                        <p class="text-slate-400 text-sm mb-4">Submit a new punishment entry for a player. This will be visible to all members.</p>
                        <form id="punishment-form">
                            <div class="mb-4">
                                <label for="punishment-type" class="block mb-2 text-sm font-medium">Punishment Type</label>
                                <select id="punishment-type" class="form-select" required>
                                    <option value="Warning">Warning</option>
                                    <option value="Kick">Kick</option>
                                    <option value="Ban">Ban</option>
                                    <option value="Temp Ban">Temp Ban</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="punishment-username" class="block mb-2 text-sm font-medium">Roblox Username</label>
                                <input type="text" id="punishment-username" class="form-input" required placeholder="Roblox username of the punished user">
                            </div>
                            <div class="mb-4">
                                <label for="punishment-reason" class="block mb-2 text-sm font-medium">Reason</label>
                                <textarea id="punishment-reason" class="form-input" rows="3" required placeholder="Reason for the punishment"></textarea>
                            </div>
                            <p id="punishment-form-message" class="text-red-400 text-sm mb-4"></p>
                            <div class="flex justify-end">
                                <button type="submit" class="btn btn-primary">Submit Punishment</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Punishment Logs Tab -->
                <div id="tab-punishment-logs" class="tab-content hidden">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Punishment Logs</h3>
                            <div class="relative">
                                <input type="text" id="search-username-input" class="form-input w-48 text-sm" placeholder="Search by Roblox Username">
                                <button id="clear-search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white" title="Clear Search">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="m15 9-6 6"/>
                                        <path d="m9 9 6 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="punishment-log-list" class="space-y-4">
                            <p class="text-center text-slate-400">Loading punishment logs...</p>
                        </div>
                    </div>
                </div>

                <!-- Owner Admin Tab -->
                <div id="tab-owner" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Join Requests</h3>
                            <div id="owner-join-requests-list" class="space-y-3">No pending requests.</div>
                             <p id="owner-join-requests-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Manage Server Members</h3>
                            <div id="server-members-list" class="log-box mb-4">No members to display.</div>
                             <p id="server-members-message" class="text-sm mt-2 text-center"></p>
                            <hr class="border-slate-700 my-6">
                            <h3 class="text-xl font-semibold text-white mb-4">Server Settings</h3>
                            <p class="text-slate-400 text-sm mb-4">Only the server name can be changed after creation. The server code is permanently linked to the server's database ID.</p>
                            <label for="edit-server-name" class="block mb-2">Server Name</label>
                            <input type="text" id="edit-server-name" class="form-input mb-4">
                            <button id="save-server-name-btn" class="btn btn-primary">Save Name</button>
                             <p id="owner-settings-success" class="text-green-400 text-sm mt-2 text-center"></p>
                             <p id="owner-settings-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <label for="edit-api-key" class="block mb-2">ER:LC Server API Key</label>
                            <input type="password" id="edit-api-key" class="form-input mb-4">
                            <button id="save-api-key-btn" class="btn btn-primary">Save API Key</button>
                            <p id="owner-api-key-success" class="text-green-400 text-sm mt-2 text-center"></p>
                            <p id="owner-api-key-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <h4 class="font-semibold text-red-400 mb-2">Danger Zone</h4>
                            <button id="delete-server-btn" class="btn btn-danger">Delete Server</button>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Manage Punishment Logs</h3>
                            <p class="text-slate-400 text-sm mb-4">Edit or delete any punishment log entry.</p>
                            <div id="owner-punishment-logs" class="space-y-4">
                                <p class="text-center text-slate-400">Loading logs for editing...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="create-server-modal" class="modal-overlay hidden">
        <div class="card max-w-lg w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Create Server</h2>
            <form id="create-server-form">
                <div class="mb-4">
                    <label for="server-name" class="block mb-2 text-sm font-medium">Server Name</label>
                    <input type="text" id="server-name" class="form-input" required placeholder="My Awesome Community">
                </div>
                <div class="mb-4">
                    <label for="server-code" class="block mb-2 text-sm font-medium">Server Code</label>
                    <input type="text" id="server-code" class="form-input" required placeholder="A unique code for users to join">
                    <p class="text-xs text-slate-400 mt-1">This must be unique across all of Zappy.</p>
                </div>
                <div class="mb-6">
                    <label for="api-key" class="block mb-2 text-sm font-medium">ER:LC Server API Key</label>
                    <input type="password" id="api-key" class="form-input" required>
                    <p class="text-xs text-yellow-400 mt-1">Your key is stored securely and is not shared with server members.</p>
                </div>
                <p id="create-server-error" class="text-red-400 text-sm mb-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-create-server-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Modal for Confirmations -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="card max-w-sm w-full text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Use __firebase_config and __app_id if available, otherwise fallback to provided config
        const firebaseConfig = {
            apiKey: "AIzaSyCF5bqrinHuV81qTrcoIerlIZAnenvspsw",
            authDomain: "zappyerlc.firebaseapp.com",
            projectId: "zappyerlc",
            storageBucket: "zappyerlc.firebasestorage.app",
            messagingSenderId: "133579238168",
            appId: "1:133579238168:web:00ff14f7c2014ae2164c6d",
            measurementId: "G-K4LDYN8L3E"
        };
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use default-app-id for local testing

        // Import statements - updated to 11.9.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, updateDoc, deleteDoc, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app); // Initialized but not used in the app logic

        // Custom Modal Logic
        const showCustomModal = (title, text, type, onConfirm) => {
            const modalOverlay = document.getElementById('custom-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            // Reset buttons
            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            modalTitle.textContent = title;
            modalText.textContent = text;
            modalOverlay.classList.remove('hidden');

            if (type === 'alert') {
                modalOkBtn.classList.remove('hidden');
                modalOkBtn.onclick = () => modalOverlay.classList.add('hidden');
            } else if (type === 'confirm') {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    modalOverlay.classList.add('hidden');
                    if (onConfirm) onConfirm();
                };
                modalCancelBtn.onclick = () => modalOverlay.classList.add('hidden');
            }
        };


        /**
         * ZappyApp
         * A structured object to organize all application logic, simulating a modular file structure.
         */
        const ZappyApp = {
            // --- STATE & CONFIG ---
            state: {
                currentUser: null,
                currentServer: null,
                shiftInterval: null,
                shiftStartTime: null,
                shiftTimerRunning: false,
                unsubscribeListeners: [], // To store unsubscribe functions for cleanup
            },

            // --- UI ELEMENT CACHING ---
            elements: {
                loadingOverlay: document.getElementById('loading-overlay'),
                authSection: document.getElementById('auth-section'),
                dashboardSection: document.getElementById('dashboard-section'),
                serverPanelSection: document.getElementById('server-panel-section'),
                createServerModal: document.getElementById('create-server-modal'),
                confirmModal: document.getElementById('confirm-modal'),

                // Dashboard Elements
                serverList: document.getElementById('server-list'),
                userEmailSpan: document.getElementById('user-email'),
                joinServerError: document.getElementById('join-server-error'),
                joinServerSuccess: document.getElementById('join-server-success'),
                serverListError: document.getElementById('server-list-error'),

                // Panel Elements
                panelServerName: document.getElementById('panel-server-name'),
                panelServerCode: document.getElementById('panel-server-code'),
                shiftTimer: document.getElementById('shift-timer'),
                shiftToggleButton: document.getElementById('shift-toggle-btn'),
                panelTabButtons: document.getElementById('panel-tab-buttons'),
                panelTabContent: document.getElementById('panel-tab-content'),
                logOutput: document.getElementById('log-output'),
                serverStatsOutput: document.getElementById('server-stats-output'),
                playerCount: document.getElementById('player-count'),
                queueCount: document.getElementById('queue-count'),
                playerList: document.getElementById('player-list'),
                joinRequestsDisplay: document.getElementById('join-requests-display'),
                commandInput: document.getElementById('command-input'),
                commandResponse: document.getElementById('command-response'),
                shiftLeaderboard: document.getElementById('shift-leaderboard'),
                ownerJoinRequestsList: document.getElementById('owner-join-requests-list'),
                editServerNameInput: document.getElementById('edit-server-name'),
                startShiftWaveBtn: document.getElementById('start-shift-wave-btn'),
                endShiftWaveBtn: document.getElementById('end-shift-wave-btn'),
                ownerJoinRequestsListError: document.getElementById('owner-join-requests-list-error'),
                
                // Punishment Tab
                punishmentForm: document.getElementById('punishment-form'),
                punishmentTypeInput: document.getElementById('punishment-type'),
                punishmentUsernameInput: document.getElementById('punishment-username'),
                punishmentReasonInput: document.getElementById('punishment-reason'),
                punishmentFormMessage: document.getElementById('punishment-form-message'),

                // Punishment Logs Tab
                punishmentLogList: document.getElementById('punishment-log-list'),
                searchUsernameInput: document.getElementById('search-username-input'),
                clearSearchBtn: document.getElementById('clear-search-btn'),
                ownerPunishmentLogs: document.getElementById('owner-punishment-logs'),
            },

            // --- INIT & SETUP ---
            init: async function() {
                try {
                    await this.setupAuth();
                    this.bindGlobalListeners();
                    this.showLoading(false);
                } catch (error) {
                    console.error("Initialization failed:", error);
                    showCustomModal("Error", "Failed to initialize the app. Please try again.", "alert");
                }
            },

            setupAuth: async function() {
                // Check for the provided custom auth token
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, async (user) => {
                    this.state.currentUser = user;
                    if (user) {
                        this.showDashboard();
                        await this.renderServerList();
                    } else {
                        this.showAuth();
                    }
                });
            },

            bindGlobalListeners: function() {
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.showDashboard());
                document.getElementById('show-create-server-modal-btn').addEventListener('click', () => {
                    this.elements.createServerModal.classList.remove('hidden');
                });
                document.getElementById('cancel-create-server-btn').addEventListener('click', () => {
                    this.elements.createServerModal.classList.add('hidden');
                });
                document.getElementById('create-server-form').addEventListener('submit', this.handleCreateServer.bind(this));
                document.getElementById('join-server-btn').addEventListener('click', this.handleJoinServer.bind(this));

                // Tabs
                this.elements.panelTabButtons.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-button')) {
                        const tab = e.target.dataset.tab;
                        this.switchTab(tab);
                    }
                });

                // Punishment system listeners
                this.elements.punishmentForm.addEventListener('submit', this.handleAddPunishment.bind(this));
                this.elements.searchUsernameInput.addEventListener('input', this.handleSearchPunishmentLogs.bind(this));
                this.elements.clearSearchBtn.addEventListener('click', this.handleClearSearch.bind(this));
            },

            // --- DISPLAY & UI HELPERS ---
            showLoading: function(show) {
                this.elements.loadingOverlay.classList.toggle('hidden', !show);
            },

            showAuth: function() {
                this.elements.authSection.classList.remove('hidden');
                this.elements.dashboardSection.classList.add('hidden');
                this.elements.serverPanelSection.classList.add('hidden');
                this.elements.punishmentLogList.innerHTML = '<p class="text-center text-slate-400">Loading punishment logs...</p>';
            },

            showDashboard: function() {
                this.elements.authSection.classList.add('hidden');
                this.elements.dashboardSection.classList.remove('hidden');
                this.elements.serverPanelSection.classList.add('hidden');
                if (this.state.unsubscribeListeners.length > 0) {
                    this.state.unsubscribeListeners.forEach(unsub => unsub());
                    this.state.unsubscribeListeners = [];
                }
                this.state.currentServer = null;
                this.elements.userEmailSpan.textContent = this.state.currentUser.email || 'Guest User';
                this.renderServerList(); // Re-render server list when returning to dashboard
            },

            showServerPanel: function(serverDoc) {
                this.state.currentServer = serverDoc.data();
                this.state.currentServer.id = serverDoc.id; // Store server ID
                this.elements.dashboardSection.classList.add('hidden');
                this.elements.serverPanelSection.classList.remove('hidden');
                this.elements.panelServerName.textContent = this.state.currentServer.name;
                this.elements.panelServerCode.textContent = `Code: ${this.state.currentServer.code}`;
                this.switchTab('main'); // Default to main tab
                this.setupServerPanelListeners();
                this.attachFirestoreListeners();
                this.updateOwnerControls();
            },

            switchTab: function(tabName) {
                // Update active tab button
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `tab-${tabName}`);
                });
            },

            // --- FIREBASE INTERACTIONS ---
            handleCreateServer: async function(e) {
                e.preventDefault();
                const serverName = document.getElementById('server-name').value;
                const serverCode = document.getElementById('server-code').value.toLowerCase().replace(/\s/g, ''); // Ensure no spaces
                const apiKey = document.getElementById('api-key').value;
                const errorElement = document.getElementById('create-server-error');
                errorElement.textContent = '';

                if (!serverName || !serverCode || !apiKey) {
                    errorElement.textContent = 'Please fill out all fields.';
                    return;
                }

                this.showLoading(true);

                try {
                    // Check if server code already exists
                    const serversRef = collection(db, `artifacts/${appId}/public/data/servers`);
                    const q = query(serversRef, where("code", "==", serverCode));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        errorElement.textContent = 'Server code already in use. Please choose another.';
                        this.showLoading(false);
                        return;
                    }

                    // Create server document
                    const newServerRef = doc(serversRef);
                    await setDoc(newServerRef, {
                        name: serverName,
                        code: serverCode,
                        ownerId: this.state.currentUser.uid,
                        members: [this.state.currentUser.uid],
                        apiKey: apiKey,
                        stats: {
                            onlinePlayers: 0,
                            totalServers: 0
                        },
                        logs: [],
                        createdAt: serverTimestamp()
                    });

                    // Add the server to the user's list
                    const userDocRef = doc(db, `artifacts/${appId}/users/${this.state.currentUser.uid}/profile/${this.state.currentUser.uid}`);
                    await updateDoc(userDocRef, {
                        servers: arrayUnion({ id: newServerRef.id, code: serverCode, role: 'owner' })
                    }, { merge: true });

                    this.elements.createServerModal.classList.add('hidden');
                    e.target.reset();
                    showCustomModal("Success", "Server created successfully!", "alert");
                    this.renderServerList();
                } catch (error) {
                    console.error("Error creating server:", error);
                    errorElement.textContent = 'Failed to create server. Please try again.';
                } finally {
                    this.showLoading(false);
                }
            },

            handleJoinServer: async function() {
                const joinCode = document.getElementById('join-code-input').value.toLowerCase().replace(/\s/g, '');
                const errorElement = this.elements.joinServerError;
                const successElement = this.elements.joinServerSuccess;
                errorElement.textContent = '';
                successElement.textContent = '';
                if (!joinCode) {
                    errorElement.textContent = 'Please enter a server code.';
                    return;
                }
                this.showLoading(true);
                try {
                    // Find the server with the given code
                    const serversRef = collection(db, `artifacts/${appId}/public/data/servers`);
                    const q = query(serversRef, where("code", "==", joinCode));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        errorElement.textContent = 'Server not found.';
                        return;
                    }

                    const serverDoc = querySnapshot.docs[0];
                    const serverData = serverDoc.data();

                    if (serverData.ownerId === this.state.currentUser.uid || serverData.members.includes(this.state.currentUser.uid)) {
                        errorElement.textContent = 'You are already a member of this server.';
                        return;
                    }

                    // Check if a join request already exists
                    const joinRequestsRef = collection(db, `artifacts/${appId}/public/data/servers/${serverDoc.id}/joinRequests`);
                    const joinReqQuery = query(joinRequestsRef, where("userId", "==", this.state.currentUser.uid));
                    const joinReqSnapshot = await getDocs(joinReqQuery);

                    if (!joinReqSnapshot.empty) {
                        errorElement.textContent = 'Your request to join this server is already pending.';
                        return;
                    }

                    // Add a new join request
                    await addDoc(joinRequestsRef, {
                        userId: this.state.currentUser.uid,
                        userEmail: this.state.currentUser.email || 'Guest User',
                        createdAt: serverTimestamp()
                    });

                    successElement.textContent = 'Join request sent! The server owner must approve your request.';
                } catch (error) {
                    console.error("Error joining server:", error);
                    errorElement.textContent = 'Failed to send join request. Please try again.';
                } finally {
                    this.showLoading(false);
                }
            },

            renderServerList: async function() {
                this.elements.serverList.innerHTML = '<p class="text-slate-400">Loading your servers...</p>';
                this.elements.serverListError.textContent = '';

                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${this.state.currentUser.uid}/profile/${this.state.currentUser.uid}`);
                    const userDoc = await getDoc(userDocRef);
                    if (!userDoc.exists() || !userDoc.data().servers || userDoc.data().servers.length === 0) {
                        this.elements.serverList.innerHTML = '<p class="text-slate-400">You are not a member of any servers yet. Create or join one above!</p>';
                        return;
                    }

                    const userServers = userDoc.data().servers;
                    const serverCardsHtml = [];

                    for (const server of userServers) {
                        const serverDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/servers/${server.id}`));
                        if (serverDoc.exists()) {
                            const serverData = serverDoc.data();
                            serverCardsHtml.push(`
                                <div class="card cursor-pointer hover:bg-slate-700 transition" data-server-id="${server.id}">
                                    <h3 class="text-xl font-semibold text-white mb-2">${serverData.name}</h3>
                                    <p class="text-slate-400 text-sm mb-2">Code: ${serverData.code}</p>
                                    <p class="text-sm">Role: <span class="font-semibold text-indigo-400">${server.role}</span></p>
                                    <p class="text-xs text-slate-500 mt-2">Server ID: ${server.id}</p>
                                </div>
                            `);
                        }
                    }

                    this.elements.serverList.innerHTML = serverCardsHtml.join('');
                    document.querySelectorAll('#server-list .card').forEach(card => {
                        card.addEventListener('click', (e) => this.handleServerSelect(e.currentTarget.dataset.serverId));
                    });
                } catch (error) {
                    console.error("Error rendering server list:", error);
                    this.elements.serverListError.textContent = 'Failed to load server list. Please refresh the page.';
                }
            },

            handleServerSelect: async function(serverId) {
                this.showLoading(true);
                try {
                    const serverDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/servers/${serverId}`));
                    if (serverDoc.exists()) {
                        this.showServerPanel(serverDoc);
                    } else {
                        showCustomModal("Error", "Server not found. It may have been deleted.", "alert");
                        this.renderServerList(); // Refresh the list
                    }
                } catch (error) {
                    console.error("Error selecting server:", error);
                    showCustomModal("Error", "Failed to load server panel.", "alert");
                } finally {
                    this.showLoading(false);
                }
            },

            setupServerPanelListeners: function() {
                // Command Execution
                const executeCommandButton = document.getElementById('execute-command-button');
                executeCommandButton.onclick = this.handleExecuteCommand.bind(this);
            },

            updateOwnerControls: function() {
                const isOwner = this.state.currentServer.ownerId === this.state.currentUser.uid;
                const ownerTab = document.getElementById('tab-owner');
                const ownerTabBtn = document.createElement('button');
                ownerTabBtn.className = 'tab-button btn btn-secondary';
                ownerTabBtn.dataset.tab = 'owner';
                ownerTabBtn.textContent = 'Admin';
                
                // Clear and re-add the owner tab button based on status
                const existingOwnerBtn = document.querySelector('[data-tab="owner"]');
                if (existingOwnerBtn) existingOwnerBtn.remove();
                if (isOwner) {
                    this.elements.panelTabButtons.appendChild(ownerTabBtn);
                    document.getElementById('edit-server-name').value = this.state.currentServer.name;
                    document.getElementById('command-input').disabled = false;
                    document.getElementById('execute-command-button').disabled = false;
                    document.getElementById('command-permission-text').textContent = 'Enter a command to execute on the ER:LC server.';
                } else {
                    document.getElementById('command-input').disabled = true;
                    document.getElementById('execute-command-button').disabled = true;
                    document.getElementById('command-permission-text').textContent = 'This functionality is restricted to the server owner.';
                }
            },

            attachFirestoreListeners: function() {
                const serverId = this.state.currentServer.id;
                this.state.unsubscribeListeners.forEach(unsub => unsub());
                this.state.unsubscribeListeners = [];

                // Listen to Server Stats
                const statsRef = doc(db, `artifacts/${appId}/public/data/servers/${serverId}`);
                this.state.unsubscribeListeners.push(onSnapshot(statsRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        this.elements.serverStatsOutput.innerHTML = `
                            <p>Online Players: ${data.stats?.onlinePlayers || 0}</p>
                            <p>Total Servers: ${data.stats?.totalServers || 0}</p>
                            <p>Members: ${data.members.length}</p>
                        `;
                    }
                }, (error) => {
                    console.error("Error listening to stats:", error);
                    this.elements.serverStatsOutput.textContent = 'Failed to load stats.';
                }));

                // Listen to Log
                const logRef = collection(db, `artifacts/${appId}/public/data/servers/${serverId}/logs`);
                this.state.unsubscribeListeners.push(onSnapshot(query(logRef, where("type", "==", "realtime_event")), (snapshot) => {
                    this.elements.logOutput.innerHTML = '';
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const newLog = change.doc.data();
                            const logEntry = document.createElement('div');
                            logEntry.textContent = newLog.message;
                            this.elements.logOutput.prepend(logEntry); // Prepend for new logs at the top
                        }
                    });
                }, (error) => {
                    console.error("Error listening to logs:", error);
                    this.elements.logOutput.textContent = 'Failed to load logs.';
                }));

                // Listen to Players & Queue
                const playerListRef = collection(db, `artifacts/${appId}/public/data/servers/${serverId}/players`);
                this.state.unsubscribeListeners.push(onSnapshot(playerListRef, (snapshot) => {
                    this.elements.playerList.innerHTML = '';
                    this.elements.playerQueue.innerHTML = '';
                    let onlineCount = 0;
                    let queueCount = 0;
                    snapshot.forEach(doc => {
                        const playerData = doc.data();
                        const playerItem = document.createElement('li');
                        playerItem.textContent = `${playerData.username} (${playerData.status})`;
                        if (playerData.status === 'online') {
                            this.elements.playerList.appendChild(playerItem);
                            onlineCount++;
                        } else if (playerData.status === 'queue') {
                            this.elements.playerQueue.appendChild(playerItem);
                            queueCount++;
                        }
                    });
                    this.elements.playerCount.textContent = onlineCount;
                    this.elements.queueCount.textContent = queueCount;
                }, (error) => {
                    console.error("Error listening to players:", error);
                }));

                // Listen to Join Requests (Owner only)
                const isOwner = this.state.currentServer.ownerId === this.state.currentUser.uid;
                if (isOwner) {
                    const joinRequestsRef = collection(db, `artifacts/${appId}/public/data/servers/${serverId}/joinRequests`);
                    this.state.unsubscribeListeners.push(onSnapshot(joinRequestsRef, (snapshot) => {
                        this.elements.ownerJoinRequestsList.innerHTML = '';
                        if (snapshot.empty) {
                            this.elements.ownerJoinRequestsList.innerHTML = '<p class="text-slate-400">No pending requests.</p>';
                            return;
                        }
                        snapshot.forEach(doc => {
                            const request = doc.data();
                            const requestEl = document.createElement('div');
                            requestEl.className = 'card p-3 flex justify-between items-center';
                            requestEl.innerHTML = `
                                <div>
                                    <p class="font-semibold text-white">${request.userEmail}</p>
                                </div>
                                <div>
                                    <button class="btn btn-primary btn-sm accept-btn" data-id="${doc.id}">Accept</button>
                                    <button class="btn btn-danger btn-sm deny-btn" data-id="${doc.id}">Deny</button>
                                </div>
                            `;
                            this.elements.ownerJoinRequestsList.appendChild(requestEl);
                        });
                        this.elements.ownerJoinRequestsList.querySelectorAll('.accept-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => this.handleAcceptJoinRequest(e.currentTarget.dataset.id));
                        });
                        this.elements.ownerJoinRequestsList.querySelectorAll('.deny-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => this.handleDenyJoinRequest(e.currentTarget.dataset.id));
                        });
                    }, (error) => {
                        console.error("Error listening to join requests:", error);
                        this.elements.ownerJoinRequestsListError.textContent = 'Failed to load join requests.';
                    }));
                }

                // Listen to Shifts
                const shiftsRef = collection(db, `artifacts/${appId}/public/data/servers/${serverId}/shifts`);
                this.state.unsubscribeListeners.push(onSnapshot(shiftsRef, (snapshot) => {
                    const shifts = [];
                    snapshot.forEach(doc => shifts.push(doc.data()));
                    this.renderShiftLeaderboard(shifts);
                }, (error) => {
                    console.error("Error listening to shifts:", error);
                }));

                // Listen to Punishment Logs
                this.state.unsubscribeListeners.push(onSnapshot(collection(db, `artifacts/${appId}/public/data/servers/${serverId}/punishmentLogs`), (snapshot) => {
                    const logs = [];
                    snapshot.forEach(doc => logs.push({ id: doc.id, ...doc.data() }));
                    this.state.punishmentLogs = logs;
                    this.renderPunishmentLogs();
                    if (isOwner) {
                        this.renderOwnerPunishmentLogs(logs);
                    }
                }, (error) => {
                    console.error("Error listening to punishment logs:", error);
                    this.elements.punishmentLogList.innerHTML = '<p class="text-center text-red-400">Failed to load punishment logs.</p>';
                    if (isOwner) {
                        this.elements.ownerPunishmentLogs.innerHTML = '<p class="text-center text-red-400">Failed to load logs for editing.</p>';
                    }
                }));
            },

            renderShiftLeaderboard: function(shifts) {
                this.elements.shiftLeaderboard.innerHTML = '';
                if (shifts.length === 0) {
                    this.elements.shiftLeaderboard.innerHTML = '<p class="text-center text-slate-400">No shifts recorded yet.</p>';
                    return;
                }
                const sortedShifts = shifts.sort((a, b) => (b.endTime - b.startTime) - (a.endTime - a.startTime));
                let html = '';
                sortedShifts.forEach((shift, index) => {
                    const duration = shift.endTime - shift.startTime;
                    const hours = Math.floor(duration / (1000 * 60 * 60));
                    const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((duration % (1000 * 60)) / 1000);
                    const formattedDuration = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    html += `
                        <div class="card p-4 flex justify-between items-center">
                            <span class="font-semibold text-white">#${index + 1} ${shift.userEmail}</span>
                            <span class="font-mono text-indigo-300">${formattedDuration}</span>
                        </div>
                    `;
                });
                this.elements.shiftLeaderboard.innerHTML = html;
            },

            handleAcceptJoinRequest: async function(docId) {
                const serverId = this.state.currentServer.id;
                this.showLoading(true);
                try {
                    const requestRef = doc(db, `artifacts/${appId}/public/data/servers/${serverId}/joinRequests`, docId);
                    const requestDoc = await getDoc(requestRef);
                    if (!requestDoc.exists()) return;

                    const requestData = requestDoc.data();
                    const batch = writeBatch(db);

                    // Add user to server members
                    const serverRef = doc(db, `artifacts/${appId}/public/data/servers/${serverId}`);
                    batch.update(serverRef, {
                        members: arrayUnion(requestData.userId)
                    });

                    // Add server to user's profile
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${requestData.userId}/profile/${requestData.userId}`);
                    batch.set(userProfileRef, {
                        servers: arrayUnion({ id: serverId, code: this.state.currentServer.code, role: 'member' })
                    }, { merge: true });

                    // Delete the join request
                    batch.delete(requestRef);

                    await batch.commit();
                    showCustomModal("Success", `Accepted request from ${requestData.userEmail}.`, "alert");
                } catch (error) {
                    console.error("Error accepting request:", error);
                    showCustomModal("Error", "Failed to accept join request.", "alert");
                } finally {
                    this.showLoading(false);
                }
            },

            handleDenyJoinRequest: async function(docId) {
                const serverId = this.state.currentServer.id;
                this.showLoading(true);
                try {
                    const requestRef = doc(db, `artifacts/${appId}/public/data/servers/${serverId}/joinRequests`, docId);
                    await deleteDoc(requestRef);
                    showCustomModal("Success", "Join request denied.", "alert");
                } catch (error) {
                    console.error("Error denying request:", error);
                    showCustomModal("Error", "Failed to deny join request.", "alert");
                } finally {
                    this.showLoading(false);
                }
            },

            handleExecuteCommand: async function() {
                if (this.state.currentServer.ownerId !== this.state.currentUser.uid) {
                    this.elements.commandResponse.textContent = "Error: Only the server owner can execute commands.";
                    this.elements.commandResponse.style.color = '#f87171'; // Red
                    return;
                }

                const command = this.elements.commandInput.value.trim();
                const responseDiv = this.elements.commandResponse;
                responseDiv.textContent = 'Executing...';
                responseDiv.style.color = '#94a3b8'; // Slate 400

                if (!command) {
                    responseDiv.textContent = 'Error: Command cannot be empty.';
                    responseDiv.style.color = '#f87171'; // Red
                    return;
                }

                try {
                    // Simulate command execution with a log entry
                    await addDoc(collection(db, `artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/logs`), {
                        type: 'command_execution',
                        command: command,
                        executedBy: this.state.currentUser.email,
                        executedAt: serverTimestamp()
                    });
                    responseDiv.textContent = `Command "${command}" executed successfully.`;
                    responseDiv.style.color = '#4ade80'; // Green
                } catch (error) {
                    console.error("Error executing command:", error);
                    responseDiv.textContent = 'Error: Failed to execute command. Please check server API status.';
                    responseDiv.style.color = '#f87171'; // Red
                }
            },

            handleAddPunishment: async function(e) {
                e.preventDefault();
                const type = this.elements.punishmentTypeInput.value;
                const username = this.elements.punishmentUsernameInput.value.trim();
                const reason = this.elements.punishmentReasonInput.value.trim();
                const messageDiv = this.elements.punishmentFormMessage;
                messageDiv.textContent = '';
                messageDiv.style.color = '#f87171';

                if (!username || !reason) {
                    messageDiv.textContent = 'Please fill out all fields.';
                    return;
                }

                this.showLoading(true);
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishmentLogs`), {
                        type,
                        username,
                        reason,
                        submittedBy: this.state.currentUser.email,
                        createdAt: serverTimestamp()
                    });
                    messageDiv.textContent = 'Punishment log submitted successfully!';
                    messageDiv.style.color = '#4ade80';
                    e.target.reset();
                } catch (error) {
                    console.error("Error adding punishment log:", error);
                    messageDiv.textContent = 'Failed to add punishment log. Please try again.';
                } finally {
                    this.showLoading(false);
                }
            },

            renderPunishmentLogs: function(searchQuery = '') {
                const logsContainer = this.elements.punishmentLogList;
                logsContainer.innerHTML = '';
                let logsToDisplay = this.state.punishmentLogs;

                if (searchQuery) {
                    logsToDisplay = logsToDisplay.filter(log => log.username.toLowerCase().includes(searchQuery.toLowerCase()));
                }

                if (logsToDisplay.length === 0) {
                    logsContainer.innerHTML = '<p class="text-center text-slate-400">No punishment logs found.</p>';
                    return;
                }

                logsToDisplay.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                logsToDisplay.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'card p-4 space-y-2';
                    const date = log.createdAt.toDate().toLocaleDateString() + ' ' + log.createdAt.toDate().toLocaleTimeString();
                    logElement.innerHTML = `
                        <p class="font-semibold text-white">Punishment: <span class="text-red-400">${log.type}</span></p>
                        <p class="text-sm">Username: <span class="font-bold text-indigo-300">${log.username}</span></p>
                        <p class="text-sm">Reason: ${log.reason}</p>
                        <p class="text-xs text-slate-500">Submitted by: ${log.submittedBy}</p>
                        <p class="text-xs text-slate-500">Date: ${date}</p>
                    `;
                    logsContainer.appendChild(logElement);
                });
            },

            renderOwnerPunishmentLogs: function(logs) {
                const logsContainer = this.elements.ownerPunishmentLogs;
                logsContainer.innerHTML = '';

                if (logs.length === 0) {
                    logsContainer.innerHTML = '<p class="text-center text-slate-400">No punishment logs found.</p>';
                    return;
                }
                
                logs.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                logs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'card p-4 space-y-2';
                    const date = log.createdAt.toDate().toLocaleDateString() + ' ' + log.createdAt.toDate().toLocaleTimeString();
                    logElement.innerHTML = `
                        <p class="font-semibold text-white">Punishment: <span class="text-red-400">${log.type}</span></p>
                        <p class="text-sm">Username: <span class="font-bold text-indigo-300">${log.username}</span></p>
                        <p class="text-sm">Reason: ${log.reason}</p>
                        <p class="text-xs text-slate-500">Submitted by: ${log.submittedBy}</p>
                        <p class="text-xs text-slate-500 mb-4">Date: ${date}</p>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary btn-sm edit-log-btn" data-id="${log.id}">Edit</button>
                            <button class="btn btn-danger btn-sm delete-log-btn" data-id="${log.id}">Delete</button>
                        </div>
                    `;
                    logsContainer.appendChild(logElement);
                });

                logsContainer.querySelectorAll('.edit-log-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleEditPunishmentLog(e.currentTarget.dataset.id));
                });
                logsContainer.querySelectorAll('.delete-log-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleDeletePunishmentLog(e.currentTarget.dataset.id));
                });
            },
            
            handleSearchPunishmentLogs: function() {
                const searchQuery = this.elements.searchUsernameInput.value.trim();
                this.renderPunishmentLogs(searchQuery);
            },
            
            handleClearSearch: function() {
                this.elements.searchUsernameInput.value = '';
                this.renderPunishmentLogs();
            },

            handleEditPunishmentLog: function(logId) {
                const log = this.state.punishmentLogs.find(l => l.id === logId);
                if (!log) {
                    showCustomModal('Error', 'Log not found.', 'alert');
                    return;
                }

                const newReason = window.prompt("Edit reason:", log.reason);
                if (newReason !== null && newReason.trim() !== '') {
                    this.showLoading(true);
                    updateDoc(doc(db, `artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishmentLogs`, logId), {
                        reason: newReason.trim(),
                        editedAt: serverTimestamp()
                    }).then(() => {
                        showCustomModal('Success', 'Log updated successfully.', 'alert');
                    }).catch(error => {
                        console.error('Error updating log:', error);
                        showCustomModal('Error', 'Failed to update log.', 'alert');
                    }).finally(() => {
                        this.showLoading(false);
                    });
                }
            },

            handleDeletePunishmentLog: function(logId) {
                showCustomModal('Confirm Delete', 'Are you sure you want to delete this punishment log? This action cannot be undone.', 'confirm', () => {
                    this.showLoading(true);
                    deleteDoc(doc(db, `artifacts/${appId}/public/data/servers/${this.state.currentServer.id}/punishmentLogs`, logId))
                        .then(() => {
                            showCustomModal('Success', 'Log deleted successfully.', 'alert');
                        })
                        .catch(error => {
                            console.error('Error deleting log:', error);
                            showCustomModal('Error', 'Failed to delete log.', 'alert');
                        })
                        .finally(() => {
                            this.showLoading(false);
                        });
                });
            },

            // Other existing functions (shift handling, etc.) can go here...
        };

        // Initialize the app when the DOM is fully loaded
        window.onload = () => {
            ZappyApp.init();
        };
    </script>
</body>
</html>
