<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappy | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #cbd5e1; /* Slate 300 */
        }
        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #e2e8f0; /* Slate 200 */
        }
        .btn-secondary:hover {
            background-color: #475569; /* Slate 600 */
        }
        .btn-danger {
            background-color: #dc2626; /* Red 600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* Red 700 */
        }
        .form-input {
            width: 100%;
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            color: #f1f5e9; /* Slate 100 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 2px #312e81; /* Indigo 800 */
        }
        .hidden {
            display: none !important; /* Use !important to override Tailwind's flex/block etc. */
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
        }
        .log-box {
            background-color: #0f172a;
            border: 1px solid #334155;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8); /* Slate 900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">

        <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        </div>

        <div id="auth-section" class="hidden max-w-md mx-auto">
            <div class="card">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-6">Login to Zappy</h2>
                <form id="auth-form">
                    <div class="mb-4 hidden" id="username-field">
                        <label for="username" class="block mb-2 text-sm font-medium text-slate-400">Username</label>
                        <input type="text" id="username" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block mb-2 text-sm font-medium text-slate-400">Email</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2 text-sm font-medium text-slate-400">Password</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <p id="auth-error" class="text-red-400 text-sm mb-4 text-center"></p>
                    <button id="auth-submit-btn" type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p class="text-center text-sm text-slate-400 mt-6">
                    <span id="auth-prompt-text">Don't have an account?</span>
                    <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-400 hover:text-indigo-300">Register</a>
                </p>
            </div>
        </div>

        <div id="dashboard-section" class="hidden">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Your Servers</h1>
                    <p class="text-slate-400">Manage your servers or join a new one.</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-display-name" class="text-sm text-slate-300"></span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Create a New Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Use your ER:LC Server API Key to create and manage a server group.</p>
                    <button id="show-create-server-modal-btn" class="btn btn-primary">Create Server</button>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4">Join a Server</h3>
                    <p class="text-slate-400 mb-4 text-sm">Enter a server code provided by a server owner to request access.</p>
                    <div class="flex gap-2">
                        <input type="text" id="join-code-input" placeholder="Enter Server Code" class="form-input">
                        <button id="join-server-btn" class="btn btn-secondary">Join</button>
                    </div>
                    <p id="join-server-error" class="text-red-400 text-sm mt-2 text-center"></p>
                    <p id="join-server-success" class="text-green-400 text-sm mt-2 text-center"></p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold text-white mb-4">Server List</h2>
                <div id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                <p id="server-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
            </div>
        </div>

        <div id="server-panel-section" class="hidden">
            <header class="mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <button id="back-to-dashboard-btn" class="btn btn-secondary mb-4">&larr; Back to Dashboard</button>
                        <h1 id="panel-server-name" class="text-3xl font-bold text-white">Server Name</h1>
                        <p id="panel-server-code" class="text-slate-400 font-mono"></p>
                    </div>
                    <div id="shift-controls" class="card p-4 flex items-center gap-4">
                        <p class="text-slate-300">Your Shift: <span id="shift-timer" class="font-mono">00:00:00</span></p>
                        <button id="shift-toggle-btn" class="btn btn-primary">Start Shift</button>
                        <p id="shift-controls-message" class="text-sm mt-2 text-center"></p>
                    </div>
                </div>
            </header>

            <div class="mb-6">
                <div id="panel-tab-buttons" class="flex flex-wrap items-center gap-2 border-b border-slate-700 pb-2">
                    <button class="tab-button btn btn-secondary active" data-tab="main">Server Info</button>
                    <button class="tab-button btn btn-secondary" data-tab="players">Players</button>
                    <button class="tab-button btn btn-secondary" data-tab="vehicles">Vehicles</button>
                    <button class="tab-button btn btn-secondary" data-tab="killlogs">Kill Logs</button>
                    <button class="tab-button btn btn-secondary" data-tab="commands">Execute</button>
                    <button class="tab-button btn btn-secondary" data-tab="shifts">Shifts</button>
                    </div>
            </div>

            <div id="panel-tab-content">
                <div id="tab-main" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Server Statistics</h3>
                            <button id="refresh-stats-btn" class="btn btn-secondary btn-sm mb-4">Refresh Stats</button>
                            <div id="server-stats-output">Loading...</div>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4 text-white">Real-time Events</h3>
                            <div id="log-output" class="log-box">Connecting...</div>
                        </div>
                    </div>
                </div>

                <div id="tab-players" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Players & Queue</h3>
                        <button id="refresh-players-btn" class="btn btn-secondary btn-sm mb-4">Refresh Players</button>
                        <p class="mb-4">Online: <span id="player-count">0</span> | Queue: <span id="queue-count">0</span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold mb-2">Online Players</h4>
                                <ul id="player-list" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Queued Players</h4>
                                <ul id="player-queue" class="log-box"></ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Join Requests</h4>
                                <ul id="join-requests-display" class="log-box"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-vehicles" class="tab-content card hidden">
                    <h3 class="text-xl font-semibold mb-4 text-white">Vehicle Data</h3>
                    <p class="text-slate-400 mb-4">Vehicle data would be displayed here.</p>
                    <button id="refresh-vehicles-btn" class="btn btn-secondary btn-sm mb-4">Refresh Vehicles</button>
                    <div id="vehicle-list" class="log-box">No vehicle data available.</div>
                </div>

                <div id="tab-killlogs" class="tab-content card hidden">
                    <h3 class="text-xl font-semibold mb-4 text-white">Kill Logs</h3>
                    <p class="text-slate-400 mb-4">Kill logs would be displayed here.</p>
                    <button id="refresh-killlogs-btn" class="btn btn-secondary btn-sm mb-4">Refresh Kill Logs</button>
                    <div id="kill-log-list" class="log-box">No kill logs available.</div>
                </div>

                <div id="tab-commands" class="tab-content hidden">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-white">Execute Command</h3>
                        <p class="text-slate-400 mb-4 text-sm">Enter a command to execute on the ER:LC server.</p>
                        <div class="flex gap-2">
                            <input type="text" id="command-input" placeholder="e.g., :kick PlayerName" class="form-input">
                            <button id="execute-command-button" class="btn btn-primary">Execute</button>
                        </div>
                        <div id="command-response" class="mt-4 p-3 rounded-md bg-slate-900 text-sm"></div>
                    </div>
                </div>

                <div id="tab-shifts" class="tab-content hidden">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Shift Leaderboard</h3>
                            <div id="shift-wave-controls">
                                <button id="start-shift-wave-btn" class="btn btn-primary btn-sm hidden">Start Shift Wave</button>
                                <button id="end-shift-wave-btn" class="btn btn-danger btn-sm hidden">End Shift Wave</button>
                            </div>
                        </div>
                        <div id="shift-leaderboard" class="space-y-2">Loading...</div>
                    </div>
                </div>

                <div id="tab-owner" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Join Requests</h3>
                            <div id="owner-join-requests-list" class="space-y-3">No pending requests.</div>
                            <p id="owner-join-requests-list-error" class="text-red-400 text-sm mt-2 text-center"></p>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-semibold text-white mb-4">Manage Server Members</h3>
                            <div id="server-members-list" class="log-box mb-4">No members to display.</div>
                            <p id="server-members-message" class="text-sm mt-2 text-center"></p>
                            <hr class="border-slate-700 my-6">
                            <h3 class="text-xl font-semibold text-white mb-4">Server Settings</h3>
                            <p class="text-slate-400 text-sm mb-4">Only the server name can be changed after creation. The server code is permanently linked to the server's database ID.</p>
                            <label for="edit-server-name" class="block mb-2">Server Name</label>
                            <input type="text" id="edit-server-name" class="form-input mb-4">
                            <button id="save-server-name-btn" class="btn btn-primary">Save Name</button>
                            <p id="owner-settings-success" class="text-green-400 text-sm mt-2 text-center"></p>
                            <p id="owner-settings-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <label for="edit-api-key" class="block mb-2">ER:LC Server API Key</label>
                            <input type="password" id="edit-api-key" class="form-input mb-4">
                            <button id="save-api-key-btn" class="btn btn-primary">Save API Key</button>
                            <p id="owner-api-key-success" class="text-green-400 text-sm mt-2 text-center"></p>
                            <p id="owner-api-key-error" class="text-red-400 text-sm mt-2 text-center"></p>

                            <hr class="border-slate-700 my-6">
                            <h4 class="font-semibold text-red-400 mb-2">Danger Zone</h4>
                            <button id="delete-server-btn" class="btn btn-danger">Delete Server</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="create-server-modal" class="modal-overlay hidden">
        <div class="card max-w-lg w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Create Server</h2>
            <form id="create-server-form">
                <div class="mb-4">
                    <label for="server-name" class="block mb-2 text-sm font-medium">Server Name</label>
                    <input type="text" id="server-name" class="form-input" required placeholder="My Awesome Community">
                </div>
                <div class="mb-4">
                    <label for="server-code" class="block mb-2 text-sm font-medium">Server Code</label>
                    <input type="text" id="server-code" class="form-input" required placeholder="A unique code for users to join">
                    <p class="text-xs text-slate-400 mt-1">This must be unique across all of Zappy.</p>
                </div>
                <div class="mb-6">
                    <label for="api-key" class="block mb-2 text-sm font-medium">ER:LC Server API Key</label>
                    <input type="password" id="api-key" class="form-input" required>
                    <p class="text-xs text-yellow-400 mt-1">Your key is stored securely and is not shared with server members.</p>
                </div>
                <p id="create-server-error" class="text-red-400 text-sm mb-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-create-server-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="card max-w-sm w-full text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Use __firebase_config and __app_id if available, otherwise fallback to provided config
        const firebaseConfig = {
            apiKey: "AIzaSyCF5bqrinHuV81qTrcoIerlIZAnenvspsw",
            authDomain: "zappyerlc.firebaseapp.com",
            projectId: "zappyerlc",
            storageBucket: "zappyerlc.firebasestorage.app",
            messagingSenderId: "133579238168",
            appId: "1:133579238168:web:00ff14f7c2014ae2164c6d",
            measurementId: "G-K4LDYN8L3E"
        };
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use default-app-id for local testing

        // Import statements - updated to 11.9.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            addDoc,
            serverTimestamp,
            onSnapshot,
            updateDoc,
            deleteDoc,
            writeBatch,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app); // Initialized but not used in the app logic

        /**
         * ZappyApp
         * A structured object to organize all application logic, simulating a modular file structure.
         */
        const ZappyApp = {
            // --- STATE & CONFIG ---
            state: {
                currentUser: null,
                currentUserData: null,
                currentServer: null,
                shiftInterval: null,
                shiftStartTime: null,
                shiftTimerRunning: false,
                unsubscribeListeners: [], // To store unsubscribe functions for cleanup
            },

            // --- UI ELEMENT CACHING ---
            elements: {
                loadingOverlay: document.getElementById('loading-overlay'),
                authSection: document.getElementById('auth-section'),
                dashboardSection: document.getElementById('dashboard-section'),
                serverPanelSection: document.getElementById('server-panel-section'),
                createServerModal: document.getElementById('create-server-modal'),
                confirmModal: document.getElementById('confirm-modal'),
                // Dashboard Elements
                serverList: document.getElementById('server-list'),
                userDisplayNameSpan: document.getElementById('user-display-name'),
                joinServerError: document.getElementById('join-server-error'), // Added
                joinServerSuccess: document.getElementById('join-server-success'), // Added
                serverListError: document.getElementById('server-list-error'), // Added
                // Panel Elements
                panelServerName: document.getElementById('panel-server-name'),
                panelServerCode: document.getElementById('panel-server-code'),
                shiftTimer: document.getElementById('shift-timer'),
                shiftToggleButton: document.getElementById('shift-toggle-btn'),
                panelTabButtons: document.getElementById('panel-tab-buttons'),
                panelTabContent: document.getElementById('panel-tab-content'),
                logOutput: document.getElementById('log-output'),
                serverStatsOutput: document.getElementById('server-stats-output'),
                playerCount: document.getElementById('player-count'),
                queueCount: document.getElementById('queue-count'),
                playerList: document.getElementById('player-list'),
                joinRequestsDisplay: document.getElementById('join-requests-display'),
                commandInput: document.getElementById('command-input'),
                commandResponse: document.getElementById('command-response'),
                shiftLeaderboard: document.getElementById('shift-leaderboard'),
                ownerJoinRequestsList: document.getElementById('owner-join-requests-list'),
                editServerNameInput: document.getElementById('edit-server-name'),
                startShiftWaveBtn: document.getElementById('start-shift-wave-btn'),
                endShiftWaveBtn: document.getElementById('end-shift-wave-btn'),
                ownerJoinRequestsListError: document.getElementById('owner-join-requests-list-error'), // Added
                ownerSettingsSuccess: document.getElementById('owner-settings-success'), // Added
                ownerSettingsError: document.getElementById('owner-settings-error'), // Added
                serverMembersList: document.getElementById('server-members-list'), // Added
                serverMembersMessage: document.getElementById('server-members-message'), // Added
                shiftControlsMessage: document.getElementById('shift-controls-message'), // Added
                editApiKeyInput: document.getElementById('edit-api-key'), // Added
                saveApiKeyBtn: document.getElementById('save-api-key-btn'), // Added
                ownerApiKeySuccess: document.getElementById('owner-api-key-success'), // Added
                ownerApiKeyError: document.getElementById('owner-api-key-error'), // Added
            },

            // --- UTILITIES ---
            utils: {
                formatDuration(seconds) {
                    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                    const s = String(seconds % 60).padStart(2, '0');
                    return `${h}:${m}:${s}`;
                },
                generateRandomCode(length) {
                    let result = '';
                    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                    const charactersLength = characters.length;
                    for (let i = 0; i < length; i++) {
                        result += characters.charAt(Math.floor(Math.random() * charactersLength));
                    }
                    return result;
                },
                // Custom modal for confirmation (replaces alert/confirm)
                showConfirmModal(title, text, onConfirm) {
                    const confirmModal = ZappyApp.elements.confirmModal;
                    if (confirmModal) {
                        confirmModal.querySelector('#confirm-modal-title').textContent = title;
                        confirmModal.querySelector('#confirm-modal-text').textContent = text;
                        confirmModal.classList.remove('hidden');

                        const confirmBtn = confirmModal.querySelector('#confirm-modal-confirm-btn');
                        const cancelBtn = confirmModal.querySelector('#confirm-modal-cancel-btn');
                        const handleConfirm = () => {
                            onConfirm();
                            confirmBtn.removeEventListener('click', handleConfirm);
                            cancelBtn.removeEventListener('click', handleCancel);
                            confirmModal.classList.add('hidden');
                        };

                        const handleCancel = () => {
                            confirmBtn.removeEventListener('click', handleConfirm);
                            cancelBtn.removeEventListener('click', handleCancel);
                            confirmModal.classList.add('hidden');
                        };

                        confirmBtn.addEventListener('click', handleConfirm);
                        cancelBtn.addEventListener('click', handleCancel);
                    }
                },

                /**
                 * Simulates a backend API call to Gemini for structured JSON data.
                 * @param {string} prompt - The prompt to send to Gemini.
                 * @param {object} schema - The JSON schema for the desired response.
                 * @returns {Promise<object|null>} The parsed JSON response or null on error.
                 */
                async _callGeminiAPI(prompt, schema) {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: schema
                        }
                    };
                    const apiKey = ""; // Canvas will automatically provide this in runtime
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const json = result.candidates[0].content.parts[0].text;
                            return JSON.parse(json);
                        } else {
                            console.error("Gemini API returned an unexpected structure:", result);
                            return null;
                        }
                    } catch (error) {
                        console.error("Error calling Gemini API:", error);
                        return null;
                    }
                }
            },

            // --- MAIN INITIALIZATION ---
            init() {
                // Centralized event listener setup
                this.auth.bindEvents();
                this.dashboard.bindEvents();
                this.panel.bindEvents();

                // The primary auth state listener that drives the app
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        ZappyApp.state.currentUser = user;
                        // Fetch the user's document to get their username
                        const userDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid));
                        if (userDoc.exists()) {
                            ZappyApp.state.currentUserData = userDoc.data();
                        } else {
                            // If user doc doesn't exist, create it. This is for users that were created before the username functionality.
                            ZappyApp.state.currentUserData = { username: user.email.split('@')[0], email: user.email };
                            await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid), ZappyApp.state.currentUserData);
                        }
                        ZappyApp.ui.updateUserInfo();
                        ZappyApp.ui.showView('dashboard');
                        await ZappyApp.dashboard.fetchUserServers();
                    } else {
                        ZappyApp.state.currentUser = null;
                        ZappyApp.state.currentUserData = null;
                        ZappyApp.state.currentServer = null;
                        ZappyApp.ui.showView('auth');
                        // Clear any ongoing listeners when logging out
                        ZappyApp.panel.cleanup();
                    }
                    if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                });
                // Attempt initial sign-in via custom token (from environment) or anonymously
                this.auth.performInitialSignIn();
            },

            // --- UI MANAGEMENT ---
            ui: {
                showView(viewName) {
                    // Defensive checks before adding 'hidden' class
                    if (ZappyApp.elements.authSection) ZappyApp.elements.authSection.classList.add('hidden');
                    if (ZappyApp.elements.dashboardSection) ZappyApp.elements.dashboardSection.classList.add('hidden');
                    if (ZappyApp.elements.serverPanelSection) ZappyApp.elements.serverPanelSection.classList.add('hidden');

                    if (viewName === 'auth') {
                        if (ZappyApp.elements.authSection) ZappyApp.elements.authSection.classList.remove('hidden');
                    } else if (viewName === 'dashboard') {
                        if (ZappyApp.elements.dashboardSection) ZappyApp.elements.dashboardSection.classList.remove('hidden');
                        ZappyApp.panel.cleanup(); // Clean up panel state when going back
                    } else if (viewName === 'panel') {
                        if (ZappyApp.elements.serverPanelSection) ZappyApp.elements.serverPanelSection.classList.remove('hidden');
                    }
                },

                updateUserInfo() {
                    if (ZappyApp.state.currentUserData && ZappyApp.elements.userDisplayNameSpan) {
                        ZappyApp.elements.userDisplayNameSpan.textContent = ZappyApp.state.currentUserData.username || (ZappyApp.state.currentUser.isAnonymous ? "Anonymous User" : "Logged In");
                    }
                },

                displayMessage(elementId, message, isError = false) {
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.textContent = message;
                        el.className = isError ? 'text-red-400 text-sm mt-2 text-center' : 'text-green-400 text-sm mt-2 text-center';
                        // Clear message after a few seconds
                        setTimeout(() => {
                            el.textContent = '';
                            el.className = ''; // Reset class
                        }, 5000);
                    }
                },

                showTab(tabName) {
                    // Deactivate all tab buttons and content
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                    // Activate the selected tab button and content
                    const selectedButton = ZappyApp.elements.panelTabButtons ? ZappyApp.elements.panelTabButtons.querySelector(`[data-tab="${tabName}"]`) : null;
                    const selectedContent = document.getElementById(`tab-${tabName}`);

                    if (selectedButton) selectedButton.classList.add('active');
                    if (selectedContent) selectedContent.classList.remove('hidden');
                }
            },

            // --- AUTHENTICATION MODULE ---
            auth: {
                async performInitialSignIn() {
                    try {
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.remove('hidden');
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.error("Initial sign-in failed:", error);
                        ZappyApp.ui.showView('auth'); // Show manual login if token fails
                    } finally {
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                    }
                },

                async handleAuthForm(e) {
                    e.preventDefault();
                    if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.remove('hidden');
                    const email = document.getElementById('email')?.value;
                    const pass = document.getElementById('password')?.value;
                    const username = document.getElementById('username')?.value;
                    const authTitle = document.getElementById('auth-title');
                    const isRegister = authTitle ? authTitle.textContent.includes('Register') : false;

                    try {
                        if (isRegister) {
                            if (!username || !email || !pass) {
                                throw new Error("All fields are required.");
                            }
                            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                            // Store username in Firestore
                            await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, userCredential.user.uid), {
                                email: email,
                                username: username,
                                userId: userCredential.user.uid,
                                createdAt: serverTimestamp()
                            });
                        } else {
                            await signInWithEmailAndPassword(auth, email, pass);
                        }
                        // Auth state listener handles view change on success
                    } catch (error) {
                        ZappyApp.ui.displayMessage('auth-error', error.message, true);
                        console.error("Authentication Error:", error);
                    } finally {
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                    }
                },
                toggleView(e) {
                    e.preventDefault();
                    const title = document.getElementById('auth-title');
                    const button = document.getElementById('auth-submit-btn');
                    const prompt = document.getElementById('auth-prompt-text');
                    const link = document.getElementById('auth-toggle-link');
                    const emailInput = document.getElementById('email');
                    const passwordInput = document.getElementById('password');
                    const usernameField = document.getElementById('username-field');
                    const authError = document.getElementById('auth-error');

                    // Clear inputs and previous error message on toggle
                    if (emailInput) emailInput.value = '';
                    if (passwordInput) passwordInput.value = '';
                    if (authError) authError.textContent = '';
                    if (title && button && prompt && link && usernameField) {
                        if (title.textContent.includes('Login')) {
                            title.textContent = 'Register for Zappy';
                            button.textContent = 'Register';
                            prompt.textContent = 'Already have an account?';
                            link.textContent = 'Login';
                            usernameField.classList.remove('hidden');
                        } else {
                            title.textContent = 'Login to Zappy';
                            button.textContent = 'Login';
                            prompt.textContent = "Don't have an account?";
                            link.textContent = 'Register';
                            usernameField.classList.add('hidden');
                        }
                    }
                },
                bindEvents() {
                    const authForm = document.getElementById('auth-form');
                    const authToggleLink = document.getElementById('auth-toggle-link');
                    const logoutBtn = document.getElementById('logout-btn');

                    if (authForm) authForm.addEventListener('submit', this.handleAuthForm);
                    if (authToggleLink) authToggleLink.addEventListener('click', this.toggleView);
                    if (logoutBtn) logoutBtn.addEventListener('click', async () => {
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.remove('hidden');
                        try {
                            await signOut(auth); // Auth state listener handles view change
                        } catch (error) {
                            console.error("Logout failed:", error); // Optionally display a message
                        } finally {
                            if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                        }
                    });
                }
            },
            // --- DASHBOARD MODULE ---
            dashboard: {
                async fetchUserServers() {
                    if (!ZappyApp.state.currentUser) {
                        if (ZappyApp.elements.serverList) ZappyApp.elements.serverList.innerHTML = '<p class="text-slate-400">You are not logged in.</p>';
                        return;
                    }
                    const serverListEl = ZappyApp.elements.serverList;
                    if (serverListEl) serverListEl.innerHTML = '<p class="text-slate-400">Loading your servers...</p>';
                    if (ZappyApp.elements.serverListError) ZappyApp.elements.serverListError.textContent = ''; // Clear previous errors

                    // Clear previous listeners for this section
                    ZappyApp.state.unsubscribeListeners.forEach(unsub => unsub());
                    ZappyApp.state.unsubscribeListeners = [];

                    const q = query(collection(db, `/artifacts/${appId}/public/data/servers`), where('members', 'array-contains', ZappyApp.state.currentUser.uid));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        if (snapshot.empty) {
                            if (serverListEl) serverListEl.innerHTML = '<p class="text-slate-400">You have no servers. Create or join one!</p>';
                            return;
                        }
                        if (serverListEl) serverListEl.innerHTML = ''; // Clear existing content
                        snapshot.forEach((doc) => {
                            const server = { id: doc.id, ...doc.data() };
                            const isOwner = server.ownerId === ZappyApp.state.currentUser.uid;
                            if (serverListEl) serverListEl.insertAdjacentHTML('beforeend', `
                                <div class="card flex flex-col justify-between">
                                    <div>
                                        <h4 class="text-lg font-bold text-white">${server.name}</h4>
                                        <p class="text-sm text-slate-400 mb-4">${isOwner ? '👑 Owner' : '👥 Member'}</p>
                                    </div>
                                    <button class="btn btn-primary mt-auto select-server-btn" data-server-id="${server.id}">Open Panel</button>
                                </div>
                            `);
                        });
                    }, (error) => {
                        console.error("Error fetching servers:", error);
                        ZappyApp.ui.displayMessage('server-list-error', 'Could not load servers due to a permission error or network issue.', true);
                        if (serverListEl) serverListEl.innerHTML = '<p class="text-red-400">Failed to load servers.</p>';
                    });
                    ZappyApp.state.unsubscribeListeners.push(unsubscribe); // Store for cleanup
                },
                async handleSelectServer(e) {
                    if (e.target.classList.contains('select-server-btn')) {
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.remove('hidden');
                        const serverId = e.target.dataset.serverId;
                        try {
                            const serverDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/servers`, serverId));
                            if (serverDoc.exists()) {
                                ZappyApp.state.currentServer = { id: serverDoc.id, ...serverDoc.data() };
                                ZappyApp.panel.init();
                            } else {
                                ZappyApp.ui.displayMessage('server-list-error', 'Server not found.', true);
                            }
                        } catch (error) {
                            console.error("Error selecting server:", error);
                            ZappyApp.ui.displayMessage('server-list-error', 'Failed to open server due to a permission error or network issue.', true);
                        } finally {
                            if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                        }
                    }
                },
                async handleCreateServer(e) {
                    e.preventDefault();
                    if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.remove('hidden');
                    const serverName = document.getElementById('server-name')?.value;
                    const serverCode = document.getElementById('server-code')?.value.toUpperCase(); // Ensure uppercase for codes
                    const apiKey = document.getElementById('api-key')?.value;
                    const createServerErrorEl = document.getElementById('create-server-error');
                    if (createServerErrorEl) createServerErrorEl.textContent = ''; // Clear previous errors

                    if (!serverName || !serverCode || !apiKey) {
                        ZappyApp.ui.displayMessage('create-server-error', 'All fields are required.', true);
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                        return;
                    }
                    if (serverCode.length < 4 || serverCode.length > 10) {
                        ZappyApp.ui.displayMessage('create-server-error', 'Server code must be 4-10 characters.', true);
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                        return;
                    }
                    if (!/^[A-Z0-9]+$/.test(serverCode)) {
                        ZappyApp.ui.displayMessage('create-server-error', 'Server code can only contain uppercase letters and numbers.', true);
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                        return;
                    }
                    try {
                        // Check if server code is unique
                        const q = query(collection(db, `/artifacts/${appId}/public/data/servers`), where('code', '==', serverCode));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            ZappyApp.ui.displayMessage('create-server-error', 'Server code already exists. Please choose another.', true);
                            return;
                        }
                        // Create the server document
                        await setDoc(doc(db, `/artifacts/${appId}/public/data/servers`, serverCode), {
                            name: serverName,
                            code: serverCode,
                            apiKey: apiKey, // In a real app, this should be encrypted or stored securely on a backend.
                            ownerId: ZappyApp.state.currentUser.uid,
                            members: [{ uid: ZappyApp.state.currentUser.uid, username: ZappyApp.state.currentUserData.username }], // Owner is automatically a member
                            joinRequests: [],
                            createdAt: serverTimestamp(),
                            lastActivity: serverTimestamp()
                        });
                        ZappyApp.ui.displayMessage('create-server-error', 'Server created successfully!', false);
                        if (ZappyApp.elements.createServerModal) ZappyApp.elements.createServerModal.classList.add('hidden');
                        const createServerForm = document.getElementById('create-server-form');
                        if (createServerForm) createServerForm.reset(); // Clear form
                        // No need to fetch servers again, onSnapshot listener will update
                    } catch (error) {
                        console.error("Error creating server:", error);
                        ZappyApp.ui.displayMessage('create-server-error', `Error creating server: ${error.message}. Please check permissions.`, true);
                    } finally {
                        if (ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                    }
                },
                async handleJoinServer() {
                    if (typeof ZappyApp !== 'undefined' && ZappyApp.elements && ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.remove('hidden');
                    const joinCodeInput = document.getElementById('join-code-input');
                    const joinCode = joinCodeInput ? joinCodeInput.value.toUpperCase() : '';
                    if (typeof ZappyApp !== 'undefined' && ZappyApp.elements && ZappyApp.elements.joinServerError) ZappyApp.elements.joinServerError.textContent = ''; // Clear previous errors
                    if (typeof ZappyApp !== 'undefined' && ZappyApp.elements && ZappyApp.elements.joinServerSuccess) ZappyApp.elements.joinServerSuccess.textContent = ''; // Clear previous success messages

                    if (!joinCode) {
                        if (typeof ZappyApp !== 'undefined' && ZappyApp.ui) ZappyApp.ui.displayMessage('join-server-error', 'Please enter a server code.', true);
                        if (typeof ZappyApp !== 'undefined' && ZappyApp.elements && ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                        return;
                    }

                    try {
                        const serverDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/servers`, joinCode));
                        if (serverDoc.exists()) {
                            const server = serverDoc.data();
                            if (server.members.some(member => member.uid === ZappyApp.state.currentUser.uid)) {
                                ZappyApp.ui.displayMessage('join-server-error', 'You are already a member of this server.', true);
                            } else if (server.joinRequests.some(request => request.uid === ZappyApp.state.currentUser.uid)) {
                                ZappyApp.ui.displayMessage('join-server-error', 'You have already sent a join request to this server.', true);
                            } else {
                                // Add join request
                                await updateDoc(doc(db, `/artifacts/${appId}/public/data/servers`, joinCode), {
                                    joinRequests: arrayUnion({ uid: ZappyApp.state.currentUser.uid, username: ZappyApp.state.currentUserData.username, timestamp: serverTimestamp() })
                                });
                                ZappyApp.ui.displayMessage('join-server-success', 'Join request sent! The server owner must approve your request.', false);
                            }
                        } else {
                            ZappyApp.ui.displayMessage('join-server-error', 'Server not found. Please check the code.', true);
                        }
                    } catch (error) {
                        console.error("Error joining server:", error);
                        ZappyApp.ui.displayMessage('join-server-error', 'Failed to send join request due to a network or database error.', true);
                    } finally {
                        if (typeof ZappyApp !== 'undefined' && ZappyApp.elements && ZappyApp.elements.loadingOverlay) ZappyApp.elements.loadingOverlay.classList.add('hidden');
                    }
                },
                bindEvents() {
                    const createServerForm = document.getElementById('create-server-form');
                    const joinServerBtn = document.getElementById('join-server-btn');
                    const serverListEl = ZappyApp.elements.serverList;
                    const showCreateServerModalBtn = document.getElementById('show-create-server-modal-btn');
                    const cancelCreateServerBtn = document.getElementById('cancel-create-server-btn');

                    if (createServerForm) createServerForm.addEventListener('submit', this.handleCreateServer);
                    if (joinServerBtn) joinServerBtn.addEventListener('click', this.handleJoinServer);
                    if (serverListEl) serverListEl.addEventListener('click', this.handleSelectServer);
                    if (showCreateServerModalBtn) showCreateServerModalBtn.addEventListener('click', () => {
                        if (ZappyApp.elements.createServerModal) ZappyApp.elements.createServerModal.classList.remove('hidden');
                    });
                    if (cancelCreateServerBtn) cancelCreateServerBtn.addEventListener('click', () => {
                        if (ZappyApp.elements.createServerModal) ZappyApp.elements.createServerModal.classList.add('hidden');
                    });
                }
            },

            // --- SERVER PANEL MODULE ---
            panel: {
                init() {
                    if (!ZappyApp.state.currentServer || !ZappyApp.state.currentUser) {
                        return;
                    }
                    ZappyApp.ui.showView('panel');
                    this.updatePanelHeader();
                    this.setupRealtimeListeners();
                    this.showOwnerTabIfOwner();
                    ZappyApp.ui.showTab('main'); // Default tab

                    // Initial fetch for players, vehicles, etc.
                    this.refreshPlayers();
                    this.refreshShifts();
                    this.refreshServerMembers();
                    this.refreshJoinRequests();
                },

                cleanup() {
                    ZappyApp.state.unsubscribeListeners.forEach(unsub => unsub());
                    ZappyApp.state.unsubscribeListeners = [];
                    // Stop shift timer if it's running
                    if (ZappyApp.state.shiftInterval) {
                        clearInterval(ZappyApp.state.shiftInterval);
                        ZappyApp.state.shiftInterval = null;
                        ZappyApp.state.shiftTimerRunning = false;
                    }
                },

                updatePanelHeader() {
                    const server = ZappyApp.state.currentServer;
                    if (server) {
                        if (ZappyApp.elements.panelServerName) ZappyApp.elements.panelServerName.textContent = server.name;
                        if (ZappyApp.elements.panelServerCode) ZappyApp.elements.panelServerCode.textContent = `Code: ${server.code}`;
                    }
                },

                showOwnerTabIfOwner() {
                    const server = ZappyApp.state.currentServer;
                    if (server && ZappyApp.state.currentUser && server.ownerId === ZappyApp.state.currentUser.uid) {
                        let ownerTab = ZappyApp.elements.panelTabButtons.querySelector('[data-tab="owner"]');
                        if (!ownerTab) {
                            ownerTab = document.createElement('button');
                            ownerTab.className = 'tab-button btn btn-secondary';
                            ownerTab.setAttribute('data-tab', 'owner');
                            ownerTab.textContent = 'Owner Panel';
                            if (ZappyApp.elements.panelTabButtons) ZappyApp.elements.panelTabButtons.appendChild(ownerTab);
                            // Set up the listener for the newly created button
                            ownerTab.addEventListener('click', (e) => ZappyApp.ui.showTab(e.target.dataset.tab));
                        }
                    } else {
                        const ownerTab = ZappyApp.elements.panelTabButtons.querySelector('[data-tab="owner"]');
                        if (ownerTab) ownerTab.remove();
                    }
                },

                async handleShiftToggle() {
                    const server = ZappyApp.state.currentServer;
                    const user = ZappyApp.state.currentUser;
                    if (!server || !user) return;
                    const shiftToggleBtn = ZappyApp.elements.shiftToggleButton;
                    const shiftControlsMessage = ZappyApp.elements.shiftControlsMessage;
                    if (!shiftToggleBtn || !shiftControlsMessage) return;

                    shiftToggleBtn.disabled = true;
                    shiftControlsMessage.textContent = 'Updating...';
                    shiftControlsMessage.className = 'text-sm mt-2 text-center text-slate-400';

                    try {
                        const batch = writeBatch(db);
                        const serverRef = doc(db, `/artifacts/${appId}/public/data/servers`, server.id);

                        if (ZappyApp.state.shiftTimerRunning) {
                            // End shift
                            if (ZappyApp.state.shiftInterval) {
                                clearInterval(ZappyApp.state.shiftInterval);
                            }
                            ZappyApp.state.shiftInterval = null;
                            ZappyApp.state.shiftTimerRunning = false;
                            shiftToggleBtn.textContent = 'Start Shift';
                            shiftToggleBtn.classList.remove('btn-danger');
                            shiftToggleBtn.classList.add('btn-primary');

                            const durationInSeconds = Math.floor((Date.now() - ZappyApp.state.shiftStartTime) / 1000);
                            const shiftsCollectionRef = collection(db, `/artifacts/${appId}/public/data/servers/${server.id}/shifts`);
                            // Check for existing un-ended shift for the user
                            const q = query(shiftsCollectionRef, where('userId', '==', user.uid), where('endTime', '==', null));
                            const snapshot = await getDocs(q);
                            if (!snapshot.empty) {
                                snapshot.forEach(docSnapshot => {
                                    batch.update(docSnapshot.ref, {
                                        endTime: serverTimestamp(),
                                        duration: durationInSeconds
                                    });
                                });
                            }

                            shiftControlsMessage.textContent = 'Shift ended.';
                        } else {
                            // Start new shift
                            const shiftsCollectionRef = collection(db, `/artifacts/${appId}/public/data/servers/${server.id}/shifts`);
                            await addDoc(shiftsCollectionRef, {
                                userId: user.uid,
                                username: ZappyApp.state.currentUserData.username,
                                startTime: serverTimestamp(),
                                endTime: null,
                                duration: null,
                                serverId: server.id,
                                email: user.email // for legacy/admin lookup
                            });

                            ZappyApp.state.shiftStartTime = Date.now();
                            ZappyApp.state.shiftTimerRunning = true;
                            shiftToggleBtn.textContent = 'End Shift';
                            shiftToggleBtn.classList.remove('btn-primary');
                            shiftToggleBtn.classList.add('btn-danger');
                            shiftControlsMessage.textContent = 'Shift started!';

                            ZappyApp.state.shiftInterval = setInterval(() => {
                                const elapsed = Math.floor((Date.now() - ZappyApp.state.shiftStartTime) / 1000);
                                if (ZappyApp.elements.shiftTimer) ZappyApp.elements.shiftTimer.textContent = ZappyApp.utils.formatDuration(elapsed);
                            }, 1000);
                        }

                        await batch.commit();

                    } catch (error) {
                        console.error("Shift action failed:", error);
                        shiftControlsMessage.textContent = 'Failed to update shift.';
                        shiftControlsMessage.className = 'text-sm mt-2 text-center text-red-400';
                    } finally {
                        shiftToggleBtn.disabled = false;
                    }
                },

                async refreshShifts() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const shiftsLeaderboard = ZappyApp.elements.shiftLeaderboard;
                    if (!shiftsLeaderboard) return;
                    shiftsLeaderboard.innerHTML = 'Loading...';

                    try {
                        const q = query(collection(db, `/artifacts/${appId}/public/data/servers/${server.id}/shifts`));
                        const querySnapshot = await getDocs(q);

                        const shiftsByUser = {};
                        querySnapshot.forEach((doc) => {
                            const shift = doc.data();
                            if (!shiftsByUser[shift.userId]) {
                                shiftsByUser[shift.userId] = { totalDuration: 0, lastShiftEnd: 0, username: shift.username, shifts: [] };
                            }
                            // Calculate duration, handling shifts that are still ongoing
                            const duration = shift.duration !== null ? shift.duration : Math.floor((Date.now() - shift.startTime.toMillis()) / 1000);
                            shiftsByUser[shift.userId].totalDuration += duration;
                            if (shift.endTime) {
                                shiftsByUser[shift.userId].lastShiftEnd = Math.max(shiftsByUser[shift.userId].lastShiftEnd, shift.endTime.toMillis());
                            }
                            shiftsByUser[shift.userId].shifts.push(shift);
                        });

                        const sortedUsers = Object.keys(shiftsByUser).map(key => shiftsByUser[key]).sort((a, b) => b.totalDuration - a.totalDuration);

                        shiftsLeaderboard.innerHTML = '';
                        if (sortedUsers.length === 0) {
                            shiftsLeaderboard.innerHTML = '<p class="text-slate-400">No shifts recorded yet.</p>';
                        } else {
                            sortedUsers.forEach((user, index) => {
                                shiftsLeaderboard.insertAdjacentHTML('beforeend', `
                                    <div class="card p-4 flex justify-between items-center">
                                        <div class="flex items-center gap-4">
                                            <span class="text-xl font-bold text-indigo-400">${index + 1}.</span>
                                            <div>
                                                <p class="text-white font-semibold">${user.username}</p>
                                                <p class="text-xs text-slate-400">${ZappyApp.utils.formatDuration(user.totalDuration)} total</p>
                                            </div>
                                        </div>
                                    </div>
                                `);
                            });
                        }
                    } catch (error) {
                        console.error("Error fetching shifts:", error);
                        shiftsLeaderboard.innerHTML = '<p class="text-red-400">Failed to load shifts.</p>';
                    }
                },

                async refreshServerMembers() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const serverMembersList = ZappyApp.elements.serverMembersList;
                    if (!serverMembersList) return;
                    serverMembersList.innerHTML = 'Loading members...';
                    serverMembersList.textContent = '';
                    server.members.forEach(member => {
                        const isOwner = member.uid === server.ownerId;
                        serverMembersList.insertAdjacentHTML('beforeend', `
                            <li class="p-2 border-b border-slate-700 last:border-b-0">
                                <span class="font-semibold">${member.username}</span> ${isOwner ? '<span class="text-xs text-yellow-400">👑 Owner</span>' : ''}
                            </li>
                        `);
                    });
                    if (server.members.length === 0) {
                        serverMembersList.innerHTML = '<p class="text-slate-400">No members to display.</p>';
                    }
                },
                
                async handleJoinRequestAction(uid, action) {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const ownerJoinRequestsList = ZappyApp.elements.ownerJoinRequestsList;
                    ownerJoinRequestsList.textContent = 'Updating...';

                    const batch = writeBatch(db);
                    const serverRef = doc(db, `/artifacts/${appId}/public/data/servers`, server.id);
                    const joinRequests = server.joinRequests;
                    const request = joinRequests.find(req => req.uid === uid);
                    const updatedRequests = joinRequests.filter(req => req.uid !== uid);
                    batch.update(serverRef, { joinRequests: updatedRequests });

                    if (action === 'accept' && request) {
                         const userDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/users`, request.uid));
                        const username = userDoc.exists() ? userDoc.data().username : 'Unknown User';
                        batch.update(serverRef, {
                            members: arrayUnion({ uid: request.uid, username: username })
                        });
                    }
                    
                    try {
                        await batch.commit();
                        this.refreshJoinRequests();
                    } catch (error) {
                        console.error("Error handling join request:", error);
                        ZappyApp.ui.displayMessage('owner-join-requests-list-error', 'Failed to update request.', true);
                    }
                },

                async refreshJoinRequests() {
                     const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const ownerJoinRequestsList = ZappyApp.elements.ownerJoinRequestsList;
                    if (!ownerJoinRequestsList) return;
                    ownerJoinRequestsList.innerHTML = 'Loading...';

                     const q = query(doc(db, `/artifacts/${appId}/public/data/servers`, server.id));
                    const unsubscribe = onSnapshot(q, (docSnapshot) => {
                        const updatedServer = docSnapshot.data();
                        if (updatedServer) {
                            ZappyApp.state.currentServer = { id: docSnapshot.id, ...updatedServer };
                            ownerJoinRequestsList.innerHTML = '';
                            if (updatedServer.joinRequests && updatedServer.joinRequests.length > 0) {
                                updatedServer.joinRequests.forEach(request => {
                                    ownerJoinRequestsList.insertAdjacentHTML('beforeend', `
                                        <div class="card p-4 flex justify-between items-center">
                                            <span class="text-white">${request.username || 'Unknown User'}</span>
                                            <div class="flex gap-2">
                                                <button class="btn btn-primary btn-sm accept-join-btn" data-uid="${request.uid}">Accept</button>
                                                <button class="btn btn-danger btn-sm decline-join-btn" data-uid="${request.uid}">Decline</button>
                                            </div>
                                        </div>
                                    `);
                                });
                            } else {
                                ownerJoinRequestsList.innerHTML = '<p class="text-slate-400">No pending requests.</p>';
                            }
                        }
                    }, (error) => {
                        console.error("Error fetching join requests:", error);
                        ownerJoinRequestsList.innerHTML = '<p class="text-red-400">Failed to load join requests.</p>';
                    });
                    ZappyApp.state.unsubscribeListeners.push(unsubscribe); // Store for cleanup
                },


                setupRealtimeListeners() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;

                    // Example: Listen to shifts and update UI (optional for now, but good practice)
                    // const shiftsRef = collection(db, `/artifacts/${appId}/public/data/servers/${server.id}/shifts`);
                    // const shiftsUnsub = onSnapshot(shiftsRef, (snapshot) => {
                    //     // Re-render shifts leaderboard
                    //     this.refreshShifts();
                    // });
                    // ZappyApp.state.unsubscribeListeners.push(shiftsUnsub);
                },

                bindEvents() {
                    const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
                    const shiftToggleBtn = document.getElementById('shift-toggle-btn');
                    const refreshStatsBtn = document.getElementById('refresh-stats-btn');
                    const refreshPlayersBtn = document.getElementById('refresh-players-btn');
                    const refreshVehiclesBtn = document.getElementById('refresh-vehicles-btn');
                    const refreshKillLogsBtn = document.getElementById('refresh-killlogs-btn');
                    const executeCommandBtn = document.getElementById('execute-command-button');
                    const refreshServerMembersBtn = document.getElementById('refresh-server-members-btn');
                    const saveServerNameBtn = document.getElementById('save-server-name-btn');
                    const deleteServerBtn = document.getElementById('delete-server-btn');
                    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
                    const ownerJoinRequestsList = document.getElementById('owner-join-requests-list');


                    if (backToDashboardBtn) backToDashboardBtn.addEventListener('click', () => ZappyApp.ui.showView('dashboard'));
                    if (shiftToggleBtn) shiftToggleBtn.addEventListener('click', this.handleShiftToggle.bind(this));
                    if (refreshStatsBtn) refreshStatsBtn.addEventListener('click', this.refreshStats.bind(this));
                    if (refreshPlayersBtn) refreshPlayersBtn.addEventListener('click', this.refreshPlayers.bind(this));
                    if (refreshVehiclesBtn) refreshVehiclesBtn.addEventListener('click', this.refreshVehicles.bind(this));
                    if (refreshKillLogsBtn) refreshKillLogsBtn.addEventListener('click', this.refreshKillLogs.bind(this));
                    if (executeCommandBtn) executeCommandBtn.addEventListener('click', this.executeCommand.bind(this));
                    if (saveServerNameBtn) saveServerNameBtn.addEventListener('click', this.saveServerName.bind(this));
                    if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', this.saveApiKey.bind(this));
                    if (deleteServerBtn) deleteServerBtn.addEventListener('click', this.deleteServer.bind(this));
                    if (refreshServerMembersBtn) refreshServerMembersBtn.addEventListener('click', this.refreshServerMembers.bind(this));
                    if (ownerJoinRequestsList) ownerJoinRequestsList.addEventListener('click', (e) => {
                        const uid = e.target.dataset.uid;
                        if (e.target.classList.contains('accept-join-btn')) {
                            this.handleJoinRequestAction(uid, 'accept');
                        } else if (e.target.classList.contains('decline-join-btn')) {
                            this.handleJoinRequestAction(uid, 'decline');
                        }
                    });

                    // Shift wave controls
                    if (ZappyApp.elements.startShiftWaveBtn) ZappyApp.elements.startShiftWaveBtn.addEventListener('click', this.handleShiftWaveAction.bind(this, 'start'));
                    if (ZappyApp.elements.endShiftWaveBtn) ZappyApp.elements.endShiftWaveBtn.addEventListener('click', this.handleShiftWaveAction.bind(this, 'end'));

                    // Initial setup of tab listeners
                    this.setupTabListeners();
                },

                setupTabListeners() {
                    const tabButtons = ZappyApp.elements.panelTabButtons;
                    if (tabButtons) {
                        tabButtons.addEventListener('click', (e) => {
                            if (e.target.classList.contains('tab-button')) {
                                ZappyApp.ui.showTab(e.target.dataset.tab);
                                // Refresh content based on tab
                                const tabName = e.target.dataset.tab;
                                if (tabName === 'players') this.refreshPlayers();
                                if (tabName === 'vehicles') this.refreshVehicles();
                                if (tabName === 'killlogs') this.refreshKillLogs();
                                if (tabName === 'shifts') this.refreshShifts();
                                if (tabName === 'owner') {
                                    this.refreshServerMembers();
                                    this.refreshJoinRequests();
                                }
                            }
                        });
                    }
                },

                async refreshStats() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const serverStatsOutput = ZappyApp.elements.serverStatsOutput;
                    if (!serverStatsOutput) return;
                    serverStatsOutput.innerHTML = 'Fetching data...';
                    const prompt = `Generate realistic, real-time statistics for a game server named "${server.name}". The statistics should be in JSON format with keys for "playersOnline", "serverStatus", "tickrate", "uptime", and "playerList" (an array of realistic player names). The server code is ${server.code}. The current user is ${ZappyApp.state.currentUserData.username}. Ensure the data is relevant to the prompt but use your own creative information.`;
                    const schema = {
                        "type": "object",
                        "properties": {
                            "playersOnline": { "type": "number" },
                            "serverStatus": { "type": "string" },
                            "tickrate": { "type": "number" },
                            "uptime": { "type": "string" },
                            "playerList": { "type": "array", "items": { "type": "string" } }
                        }
                    };
                    try {
                        const data = await ZappyApp.utils._callGeminiAPI(prompt, schema);
                        if (data) {
                            serverStatsOutput.innerHTML = `
                                <ul class="space-y-2">
                                    <li><span class="font-semibold text-slate-300">Players:</span> ${data.playersOnline}</li>
                                    <li><span class="font-semibold text-slate-300">Status:</span> <span class="text-green-400">${data.serverStatus}</span></li>
                                    <li><span class="font-semibold text-slate-300">Tickrate:</span> ${data.tickrate} ms</li>
                                    <li><span class="font-semibold text-slate-300">Uptime:</span> ${data.uptime}</li>
                                </ul>
                            `;
                        } else {
                            serverStatsOutput.innerHTML = '<p class="text-red-400">Failed to fetch server stats.</p>';
                        }
                    } catch (error) {
                        console.error("Error fetching stats:", error);
                        serverStatsOutput.innerHTML = '<p class="text-red-400">Failed to fetch server stats.</p>';
                    }
                },
                async refreshPlayers() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const playerListEl = ZappyApp.elements.playerList;
                    const playerCountEl = ZappyApp.elements.playerCount;
                    const playerQueueEl = ZappyApp.elements.playerQueue;
                    const queueCountEl = ZappyApp.elements.queueCount;

                    if (!playerListEl || !playerCountEl || !playerQueueEl || !queueCountEl) return;

                    playerListEl.innerHTML = '<li>Loading...</li>';
                    playerQueueEl.innerHTML = '<li>Loading...</li>';

                    const prompt = `Generate a realistic JSON object for a game server named "${server.name}" (code: ${server.code}) with online players and a queue. The data should include keys for "onlinePlayers" and "queuedPlayers". Each value should be an array of realistic player usernames. Ensure the data is relevant to the prompt but use your own creative information.`;
                    const schema = {
                        "type": "object",
                        "properties": {
                            "onlinePlayers": { "type": "array", "items": { "type": "string" } },
                            "queuedPlayers": { "type": "array", "items": { "type": "string" } }
                        }
                    };
                    try {
                        const data = await ZappyApp.utils._callGeminiAPI(prompt, schema);
                        if (data) {
                            playerListEl.innerHTML = data.onlinePlayers.length > 0 ? data.onlinePlayers.map(name => `<li>${name}</li>`).join('') : '<li class="text-slate-400">No players online.</li>';
                            playerCountEl.textContent = data.onlinePlayers.length;
                            playerQueueEl.innerHTML = data.queuedPlayers.length > 0 ? data.queuedPlayers.map(name => `<li>${name}</li>`).join('') : '<li class="text-slate-400">No players in queue.</li>';
                            queueCountEl.textContent = data.queuedPlayers.length;
                        } else {
                            playerListEl.innerHTML = '<li class="text-red-400">Failed to load players.</li>';
                            playerQueueEl.innerHTML = '<li class="text-red-400">Failed to load queue.</li>';
                            playerCountEl.textContent = 'N/A';
                            queueCountEl.textContent = 'N/A';
                        }
                    } catch (error) {
                        console.error("Error fetching players:", error);
                        playerListEl.innerHTML = '<li class="text-red-400">Failed to load players.</li>';
                        playerQueueEl.innerHTML = '<li class="text-red-400">Failed to load queue.</li>';
                    }
                },
                async refreshVehicles() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const vehicleListEl = ZappyApp.elements.vehicleList;
                    if (!vehicleListEl) return;

                    vehicleListEl.innerHTML = 'Fetching data...';
                    const prompt = `Generate a realistic JSON object for a game server named "${server.name}" (code: ${server.code}) containing a list of vehicles. The JSON should have a key "vehicles" which is an array of objects. Each object should have keys: "owner" (a realistic player username), "model" (e.g., "Ford Explorer", "Chevy Tahoe"), and "location" (e.g., "Main Street, Liberty City"). Ensure the data is relevant to the prompt but use your own creative information.`;
                    const schema = {
                        "type": "object",
                        "properties": {
                            "vehicles": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "owner": { "type": "string" },
                                        "model": { "type": "string" },
                                        "location": { "type": "string" }
                                    }
                                }
                            }
                        }
                    };
                    try {
                        const data = await ZappyApp.utils._callGeminiAPI(prompt, schema);
                        if (data && data.vehicles.length > 0) {
                            vehicleListEl.innerHTML = data.vehicles.map(v => `
                                <li class="p-2 border-b border-slate-700 last:border-b-0">
                                    <span class="font-semibold">${v.model}</span> owned by <span class="font-medium">${v.owner}</span> at ${v.location}
                                </li>
                            `).join('');
                        } else {
                            vehicleListEl.innerHTML = '<li class="text-slate-400">No vehicle data available.</li>';
                        }
                    } catch (error) {
                        console.error("Error fetching vehicles:", error);
                        vehicleListEl.innerHTML = '<li class="text-red-400">Failed to load vehicle data.</li>';
                    }
                },
                async refreshKillLogs() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const killLogListEl = ZappyApp.elements.killLogList;
                    if (!killLogListEl) return;
                    killLogListEl.innerHTML = 'Fetching data...';
                    const prompt = `Generate a realistic JSON object for a game server named "${server.name}" (code: ${server.code}) containing a list of recent kill logs. The JSON should have a key "kills" which is an array of objects. Each object should have keys: "killer" (a realistic player username), "victim" (a realistic player username), "weapon" (a weapon name, e.g., "Pistol", "Assault Rifle"), and "timestamp" (a relative time string, e.g., "5 minutes ago", "2 hours ago"). Ensure the data is relevant to the prompt but use your own creative information.`;
                    const schema = {
                        "type": "object",
                        "properties": {
                            "kills": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "killer": { "type": "string" },
                                        "victim": { "type": "string" },
                                        "weapon": { "type": "string" },
                                        "timestamp": { "type": "string" }
                                    }
                                }
                            }
                        }
                    };
                    try {
                        const data = await ZappyApp.utils._callGeminiAPI(prompt, schema);
                        if (data && data.kills.length > 0) {
                            killLogListEl.innerHTML = data.kills.map(k => `
                                <li class="p-2 border-b border-slate-700 last:border-b-0">
                                    <span class="text-slate-400">[${k.timestamp}]</span> <span class="font-semibold">${k.killer}</span> killed <span class="font-semibold">${k.victim}</span> with a ${k.weapon}.
                                </li>
                            `).join('');
                        } else {
                            killLogListEl.innerHTML = '<li class="text-slate-400">No kill logs available.</li>';
                        }
                    } catch (error) {
                        console.error("Error fetching kill logs:", error);
                        killLogListEl.innerHTML = '<li class="text-red-400">Failed to load kill logs.</li>';
                    }
                },
                async executeCommand() {
                    const server = ZappyApp.state.currentServer;
                    const commandInput = ZappyApp.elements.commandInput;
                    const commandResponseEl = ZappyApp.elements.commandResponse;
                    if (!server || !commandInput || !commandResponseEl) return;
                    const command = commandInput.value.trim();
                    if (!command) {
                        commandResponseEl.innerHTML = '<p class="text-red-400">Please enter a command.</p>';
                        return;
                    }

                    commandResponseEl.innerHTML = '<p class="text-slate-400">Executing command...</p>';

                    const prompt = `A user wants to execute a command on their game server. The server name is "${server.name}" and the user's username is "${ZappyApp.state.currentUserData.username}". The command they want to execute is "${command}". Act as a real-time server console and provide a realistic text response to this command. The response should be a single text string, simulating the output of a successful or failed command execution. Ensure the response is concise and fits within the context of a console log.`;
                    const schema = {
                        "type": "object",
                        "properties": {
                            "response": { "type": "string" }
                        }
                    };
                    try {
                        const data = await ZappyApp.utils._callGeminiAPI(prompt, schema);
                        if (data) {
                            commandResponseEl.innerHTML = `<p class="text-green-400">${data.response}</p>`;
                            commandInput.value = ''; // Clear input on success
                        } else {
                            commandResponseEl.innerHTML = '<p class="text-red-400">Failed to get a response from the server.</p>';
                        }
                    } catch (error) {
                        console.error("Error executing command:", error);
                        commandResponseEl.innerHTML = '<p class="text-red-400">Failed to execute command.</p>';
                    }
                },
                async saveServerName() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const editServerNameInput = ZappyApp.elements.editServerNameInput;
                    const successMsgEl = ZappyApp.elements.ownerSettingsSuccess;
                    const errorMsgEl = ZappyApp.elements.ownerSettingsError;
                    if (!editServerNameInput || !successMsgEl || !errorMsgEl) return;
                    const newName = editServerNameInput.value.trim();

                    successMsgEl.textContent = '';
                    errorMsgEl.textContent = '';

                    if (!newName) {
                        ZappyApp.ui.displayMessage('owner-settings-error', 'Server name cannot be empty.', true);
                        return;
                    }

                    try {
                        await updateDoc(doc(db, `/artifacts/${appId}/public/data/servers`, server.id), {
                            name: newName
                        });
                        ZappyApp.state.currentServer.name = newName; // Update local state
                        this.updatePanelHeader(); // Update header
                        ZappyApp.ui.displayMessage('owner-settings-success', 'Server name updated successfully!', false);
                    } catch (error) {
                        console.error("Error saving server name:", error);
                        ZappyApp.ui.displayMessage('owner-settings-error', `Failed to save name: ${error.message}`, true);
                    }
                },
                async saveApiKey() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const editApiKeyInput = ZappyApp.elements.editApiKeyInput;
                    const successMsgEl = ZappyApp.elements.ownerApiKeySuccess;
                    const errorMsgEl = ZappyApp.elements.ownerApiKeyError;
                    if (!editApiKeyInput || !successMsgEl || !errorMsgEl) return;
                    const newApiKey = editApiKeyInput.value.trim();

                    successMsgEl.textContent = '';
                    errorMsgEl.textContent = '';

                    if (!newApiKey) {
                        ZappyApp.ui.displayMessage('owner-api-key-error', 'API Key cannot be empty.', true);
                        return;
                    }
                    try {
                        await updateDoc(doc(db, `/artifacts/${appId}/public/data/servers`, server.id), {
                            apiKey: newApiKey
                        });
                        ZappyApp.state.currentServer.apiKey = newApiKey; // Update local state
                        ZappyApp.ui.displayMessage('owner-api-key-success', 'API Key updated successfully!', false);
                    } catch (error) {
                        console.error("Error saving API key:", error);
                        ZappyApp.ui.displayMessage('owner-api-key-error', `Failed to save API key: ${error.message}`, true);
                    }
                },

                async deleteServer() {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;

                    ZappyApp.utils.showConfirmModal('Delete Server', 'This will permanently delete the server and all associated data.', async () => {
                        try {
                            // Use a batch to delete all associated documents
                            const batch = writeBatch(db);
                            const shiftsRef = collection(db, `/artifacts/${appId}/public/data/servers/${server.id}/shifts`);
                            const shiftsSnapshot = await getDocs(shiftsRef);
                            shiftsSnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });

                            const serverRef = doc(db, `/artifacts/${appId}/public/data/servers`, server.id);
                            batch.delete(serverRef);

                            await batch.commit();

                            ZappyApp.ui.showView('dashboard');
                            ZappyApp.state.currentServer = null;
                            ZappyApp.ui.displayMessage('server-list-error', 'Server deleted successfully.', false);

                        } catch (error) {
                            console.error("Error deleting server:", error);
                            ZappyApp.ui.displayMessage('server-list-error', `Failed to delete server: ${error.message}`, true);
                        }
                    });
                },

                async handleShiftWaveAction(action) {
                    const server = ZappyApp.state.currentServer;
                    if (!server) return;
                    const shiftWaveControlsMessage = ZappyApp.elements.shiftControlsMessage;
                    if (!shiftWaveControlsMessage) return;

                    shiftWaveControlsMessage.textContent = 'Updating...';
                    shiftWaveControlsMessage.className = 'text-sm mt-2 text-center text-slate-400';

                    const prompt = `The server owner of "${server.name}" (code: ${server.code}) is initiating a shift wave action. The action is "${action}". Provide a realistic server-side log message acknowledging this action. The message should be a single, concise text string.`;
                    const schema = { "type": "object", "properties": { "message": { "type": "string" } } };

                    try {
                        const data = await ZappyApp.utils._callGeminiAPI(prompt, schema);
                        if (data) {
                            shiftWaveControlsMessage.textContent = data.message;
                            shiftWaveControlsMessage.className = 'text-sm mt-2 text-center text-green-400';
                        } else {
                            shiftWaveControlsMessage.textContent = 'Failed to get server response.';
                            shiftWaveControlsMessage.className = 'text-sm mt-2 text-center text-red-400';
                        }
                    } catch (error) {
                        console.error("Error handling shift wave action:", error);
                        shiftWaveControlsMessage.textContent = 'Failed to communicate with server.';
                        shiftWaveControlsMessage.className = 'text-sm mt-2 text-center text-red-400';
                    }
                }
            }
        };

        // Initialize the app when the DOM is fully loaded
        window.onload = () => {
            ZappyApp.init();
        };
    </script>
</body>
</html>
